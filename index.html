<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçû Bakery Management System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- TOP NAV: Home / Mobile Menu Toggle -->
    <div class="top-nav" id="topNav" style="display:none">
        <button class="mobile-menu-toggle-top" id="mobileMenuToggleTop" onclick="app.toggleMobileSidebar()" style="display:none">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <button class="btn-home" onclick="app.goHome()">üè† Home</button>
    </div>
    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <img src="img/logo.png" alt="Logo" onerror="this.style.display='none'">
            <h1>üçû</h1>
            <h1>Village Windmill Bakery</h1>
            <p>Real-time Management System</p>

            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username">
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>

            <label style="display:flex;align-items:center;gap:8px;margin-bottom:15px;font-size:14px;color:#444;">
                <input type="checkbox" id="rememberMe">
                <span>Remember me on this device</span>
            </label>

            <button class="btn btn-primary" onclick="app.login()">Login</button>

            <div class="demo-users">
                <p><strong>Demo Accounts:</strong></p>
                <p>Admin: admin / admin123</p>
                <p>Manager: manager / manager123</p>
                <p>Staff: staff / staff123</p>
            </div>
        </div>
    </div>

    <!-- MODULES PAGE -->
    <div class="modules-page" id="modulesPage">
        <div class="modules-container">
            <div class="user-profile-modules">
                <p><strong id="modulesUserName">User</strong></p>
                <p id="modulesUserRole">Role: Staff</p>
                <button class="logout-modules-btn" onclick="app.logout()">üö™ Logout</button>
            </div>

            <div class="modules-header">
                <img src="img/logo.png" alt="Logo" onerror="this.style.display='none'">
                <h2>üçû Village Windmill Bakery</h2>
                <p>Select a module to manage</p>
            </div>

            <div class="modules-grid" id="modulesGrid">
                <button class="module-btn" onclick="app.showPage('manufacturing')">
                    <span class="module-icon">üè≠</span>
                    <span class="module-title">Manufacturing</span>
                    <span class="module-desc">Manufacture products</span>
                </button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboard">
        <!-- MOBILE OVERLAY -->
        <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay" onclick="app.toggleMobileSidebar()"></div>
        
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">üçû Bakery Admin</div>

            <div class="user-info">
                <p><strong id="sidebarUserName">User</strong></p>
                <p id="sidebarUserRole">Role: Staff</p>
                <p id="sidebarUserStatus">‚óè Online</p>
            </div>

            <!-- Admin Section -->
            <div class="nav-section" id="adminSection">
                <div class="nav-section-title">Admin</div>
                <div class="nav-item active" data-page="dashboard" onclick="app.showPage('dashboard')">üìä Dashboard</div>
                <div class="nav-item" data-page="users" onclick="app.showPage('users')">üë• User Management</div>
                <div class="nav-item" data-page="customers" onclick="app.showPage('customers')">üè∑ Customers</div>
                <div class="nav-item" data-page="categories" onclick="app.showPage('categories')">üìÇ Categories</div>
                <div class="nav-item" data-page="permissions" onclick="app.showPage('permissions')">üîê Permissions</div>
                <div class="nav-item" data-page="orders" onclick="app.showPage('orders')">üì¶ Orders</div>
                <div class="nav-item" data-page="reports" onclick="app.showPage('reports')">üìä Reports</div>
            </div>

            <!-- Manager Section -->
            <div class="nav-section" id="managerSection" class="hidden">
                <div class="nav-section-title">Manager</div>
                <div class="nav-item" data-page="dashboard" onclick="app.showPage('dashboard')">üìä Dashboard</div>
                <div class="nav-item" data-page="products" onclick="app.showPage('products')">ü•ê Products</div>
                <div class="nav-item" data-page="customers" onclick="app.showPage('customers')">üè∑ Customers</div>
                <div class="nav-item" data-page="categories" onclick="app.showPage('categories')">üìÇ Categories</div>
                <div class="nav-item" data-page="orders" onclick="app.showPage('orders')">üì¶ Orders</div>
                <div class="nav-item" data-page="inventory" onclick="app.showPage('inventory')">üì¶ Inventory</div>
                <div class="nav-item" data-page="reports" onclick="app.showPage('reports')">üìä Reports</div>
            </div>

            <!-- Staff Section -->
            <div class="nav-section" id="staffSection" class="hidden">
                <div class="nav-section-title">Staff</div>
                <div class="nav-item" data-page="dashboard" onclick="app.showPage('dashboard')">üìä Dashboard</div>
                <div class="nav-item" data-page="orders" onclick="app.showPage('orders')">üì¶ Orders</div>
            </div>

            <button class="logout-btn" onclick="app.logout()">üö™ Logout</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- DASHBOARD PAGE -->
            <div class="page active" id="dashboardPage">
                <div class="page-header">
                    <h2>Dashboard</h2>
                    <p>Welcome to your bakery management system</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="statUsers">3</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Orders</div>
                        <div class="stat-value" id="statOrders">12</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Products</div>
                        <div class="stat-value" id="statProducts">25</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Revenue Today</div>
                        <div class="stat-value" id="statRevenue">$1,250</div>
                    </div>
                </div>

                <div class="content-card">
                    <h3>Recent Activities</h3>
                    <div id="recentActivities">
                        <p>System initialized successfully</p>
                    </div>
                </div>
            </div>

            <!-- USER MANAGEMENT PAGE -->
            <div class="page" id="usersPage">
                <div class="page-header">
                    <h2>User Management</h2>
                    <p>Create and manage users and their permissions</p>
                </div>

                <div class="content-card">
                    <button class="btn btn-primary" onclick="app.showUserModal()" style="margin-bottom: 20px;">‚ûï Add New User</button>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CUSTOMERS PAGE -->
            <div class="page" id="customersPage">
                <div class="page-header">
                    <h2>Customers</h2>
                    <p>Manage customers and allowed products</p>
                </div>

                <div class="content-card">
                    <button class="btn btn-primary" onclick="app.showCustomerModal()" style="margin-bottom: 20px;">‚ûï Add Customer</button>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Allowed</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PERMISSIONS PAGE -->
            <div class="page" id="permissionsPage">
                <div class="page-header">
                    <h2>Permissions Management</h2>
                    <p>Configure role-based access rights</p>
                </div>

                <div class="content-card">
                    <div id="permissionsContent"></div>
                </div>
            </div>

            <!-- PRODUCTS PAGE -->
            <div class="page" id="productsPage">
                <div class="page-header">
                    <h2>Products</h2>
                    <p>Manage bakery products and inventory</p>
                </div>

                <div class="content-card">
                    <button class="btn btn-primary" onclick="app.openStockEditor()" style="margin-bottom: 20px;">‚ûï Add Product</button>

                    <div id="productsContent">
                        <p>No products yet</p>
                    </div>
                </div>
            </div>

            <!-- CATEGORIES PAGE -->
            <div class="page" id="categoriesPage">
                <div class="page-header">
                    <h2>Categories</h2>
                    <p>Manage stock item categories</p>
                </div>

                <div class="content-card">
                    <button class="btn btn-primary" onclick="app.showCategoryModal()" style="margin-bottom: 20px;">‚ûï Add Category</button>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ORDERS PAGE -->
            <div class="page" id="ordersPage">
                <div class="page-header">
                    <h2>Orders</h2>
                    <p>View and manage customer orders</p>
                </div>

                <div class="content-card">
                    <div id="ordersContent">
                        <p>No orders yet</p>
                    </div>
                </div>
            </div>

            <!-- INVENTORY PAGE -->
            <div class="page" id="inventoryPage">
                <div class="page-header">
                    <h2>Inventory</h2>
                    <p>Track stock levels</p>
                </div>

                <div class="content-card">
                    <div id="inventoryContent">
                        <p>No inventory items yet</p>
                    </div>
                </div>
            </div>
            
            <!-- SHOP PAGE (Customer storefront) -->
            <div class="page" id="shopPage" style="display:none;">
                <div class="page-header">
                    <h2>Shop</h2>
                    <p>Customer storefront</p>
                </div>

                <div class="content-card">
                    <div id="shopContent">Loading shop...</div>
                </div>
            </div>

            <!-- OPERATION PAGE -->
            <div class="page" id="operationPage" style="display:none;">
                <div class="page-header">
                    <h2>Operation</h2>
                    <p>Track production operations</p>
                </div>

                <div class="content-card">
                    <div class="operation-subtabs" style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-primary operation-subtab-btn" data-section="shift" onclick="app.showOperationSection('shift')">Shift Input</button>
                        <button class="btn btn-secondary operation-subtab-btn" data-section="history" onclick="app.showOperationSection('history')">History Search</button>
                        <button class="btn btn-secondary operation-subtab-btn" data-section="master" onclick="app.showOperationSection('master')">Master Report</button>
                    </div>
                </div>

                <div id="operationPermissionNotice" style="display:none;margin-bottom:15px;padding:12px;border:1px solid #fecdd3;background:#fff1f2;color:#b91c1c;border-radius:10px;font-size:13px;">
                    Your account does not have access to any operation tools. Ask an administrator to enable the required permissions.
                </div>

                <div class="content-card operation-section" data-section="shift" id="operationShiftSection">
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="app.showOperationModal()">+ Add Operation</button>
                        <button class="btn btn-secondary" id="operationResetBtn" onclick="app.resetOperationData()">End Shift (Reset)</button>
                        <button class="btn btn-secondary" id="operationStartShiftBtn" onclick="app.startOperationShift()">Start New Shift</button>
                        <div style="flex:1;"></div>
                        <input id="operationReportSearch" placeholder="Search operations" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:220px" oninput="app.renderOperationTable()">
                    </div>
                    <div id="operationShiftStatus" style="margin:-5px 0 12px 0;color:#555;font-size:13px;"></div>
                    <div id="operationContent"></div>
                </div>

                <div class="content-card operation-section" data-section="history" id="operationHistorySection" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                        <h3 style="margin:0;">Operation Reports</h3>
                        <input id="operationHistorySearch" placeholder="Search all operations" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:240px" oninput="app.renderOperationReports()">
                    </div>
                    <div id="operationReportsContainer" style="overflow-x:auto;"><p style="color:#777;">No data yet</p></div>
                </div>

                <div class="content-card operation-section" data-section="master" id="operationMasterSection" style="display:none;">
                    <div style="display:flex;flex-wrap:wrap;gap:15px;align-items:flex-end;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Start Date</label>
                            <input type="date" id="operationFilterStart" onchange="app.renderOperationMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">End Date</label>
                            <input type="date" id="operationFilterEnd" onchange="app.renderOperationMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Category</label>
                            <select id="operationFilterCategory" onchange="app.renderOperationMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="">All categories</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Item</label>
                            <select id="operationFilterItem" onchange="app.renderOperationMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:200px;">
                                <option value="">All items</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Shift</label>
                            <select id="operationFilterShift" onchange="app.renderOperationMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="">All shifts</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Sort By</label>
                            <select id="operationSortBy" onchange="app.renderOperationMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="dateDesc">Date (Newest)</option>
                                <option value="dateAsc">Date (Oldest)</option>
                                <option value="category">Category</option>
                                <option value="item">Item</option>
                                <option value="shift">Shift</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:10px;align-items:flex-end;">
                            <button class="btn btn-secondary" id="operationExportBtn" onclick="app.exportOperationMasterReport()">Export CSV</button>
                        </div>
                    </div>
                    <div style="margin-top:15px;font-weight:600;color:#444;">
                        <span id="operationMasterCount">0 records</span>
                    </div>
                    <div id="operationMasterTable" style="margin-top:12px;overflow-x:auto;"></div>
                </div>
            </div>

            <!-- PRODUCTION PAGE -->
            <div class="page" id="productionPage" style="display:none;">
                <div class="page-header">
                    <h2>Production</h2>
                    <p>Track production progress and targets</p>
                </div>

                <div class="content-card">
                    <div style="margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="app.showProductionModal()">+ Record Production</button>
                        <input type="file" id="odooImportFile" accept=".csv,.xlsx,.xls" style="margin-left:12px;" onchange="app.handleOdooImport(event)">
                        <small style="display:block;color:#666;margin-top:4px;">Import Odoo requirements (CSV/XLSX)</small>
                        <button class="btn btn-secondary" style="margin-top:8px;" onclick="app.resetProductionData()">‚ôª Reset Production</button>
                    </div>
                    <div id="productionContent"></div>
                </div>

                <div class="content-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                        <h3 style="margin:0;">Production Archive History</h3>
                        <input id="productionArchiveSearch" placeholder="Search item or date" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:220px;" oninput="app.renderProductionArchives()">
                    </div>
                    <div id="productionArchiveContent"></div>
                </div>

                <div class="content-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
                        <h3 style="margin:0;">Production Master Report</h3>
                        <small style="color:#666;">Review every production entry with filters and export</small>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Start Date</label>
                            <input type="date" id="productionFilterStart" onchange="app.renderProductionMasterReport()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">End Date</label>
                            <input type="date" id="productionFilterEnd" onchange="app.renderProductionMasterReport()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Category</label>
                            <select id="productionFilterCategory" onchange="app.renderProductionMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="">All categories</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Item</label>
                            <select id="productionFilterItem" onchange="app.renderProductionMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:200px;">
                                <option value="">All items</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Shift</label>
                            <select id="productionFilterShift" onchange="app.renderProductionMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="">All shifts</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Sort By</label>
                            <select id="productionSortBy" onchange="app.renderProductionMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="dateDesc">Date (Newest)</option>
                                <option value="dateAsc">Date (Oldest)</option>
                                <option value="category">Category</option>
                                <option value="item">Item</option>
                                <option value="shift">Shift</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:10px;align-items:flex-end;">
                            <button class="btn btn-secondary" onclick="app.exportProductionMasterReport()">Export CSV</button>
                        </div>
                    </div>
                    <div style="margin-top:15px;font-weight:600;color:#444;">
                        <span id="productionMasterCount">0 records</span>
                    </div>
                    <div id="productionMasterTable" style="margin-top:12px;overflow-x:auto;"></div>
                </div>
            </div>

            <!-- MANUFACTURING PAGE -->
            <div class="page" id="manufacturingPage" style="display:none;">
                <div class="page-header">
                    <h2>Manufacturing</h2>
                    <p>Convert BOM recipes into finished goods batches</p>
                </div>

                <div class="content-card">
                    <div style="display:flex;flex-wrap:wrap;gap:15px;align-items:flex-end;">
                        <div style="flex:1;min-width:220px;">
                            <label style="font-weight:600;display:block;margin-bottom:6px;">Finished Good</label>
                            <select id="manufacturingProductSelect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" onchange="app.updateManufacturingPlan()">
                                <option value="">Select an item with a BOM</option>
                            </select>
                        </div>
                        <div style="width:180px;">
                            <label style="font-weight:600;display:block;margin-bottom:6px;">Quantity to Produce</label>
                            <input type="number" id="manufacturingQuantity" min="1" value="1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="app.updateManufacturingPlan()">
                        </div>
                    </div>

                    <div id="manufacturingStatus" style="margin-top:12px;color:#666;">Select a product to generate material requirements.</div>

                    <div style="margin-top:15px;overflow-x:auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Required</th>
                                    <th>Available</th>
                                    <th>Difference</th>
                                </tr>
                            </thead>
                            <tbody id="manufacturingBomBody">
                                <tr>
                                    <td colspan="4" style="text-align:center;color:#999;">Select a product to view BOM requirements</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:15px;flex-wrap:wrap;gap:10px;">
                        <div id="manufacturingSummary" style="color:#444;font-weight:600;"></div>
                        <button class="btn btn-primary" id="manufacturingConfirmBtn" onclick="app.confirmManufacturingRun()" disabled>Confirm Manufacturing</button>
                    </div>
                </div>

                <div class="content-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h3 style="margin:0;">Recent Manufacturing</h3>
                        <span id="manufacturingHistoryCount" style="color:#777;font-size:14px;"></span>
                    </div>
                    <div id="manufacturingHistory"></div>
                </div>
            </div>

            <!-- PACKAGING PAGE -->
            <div class="page" id="packagingPage" style="display:none;">
                <div class="page-header">
                    <h2>Packaging</h2>
                    <p>Track packaging operations</p>
                </div>

                <div class="content-card">
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="app.showPackagingModal()">+ Add Packaging</button>
                        <button class="btn btn-secondary" onclick="app.resetPackagingData()">End Shift (Reset)</button>
                        <div style="flex:1;"></div>
                        <input id="packagingReportSearch" placeholder="Search packaging" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:220px" oninput="app.renderPackagingTable()">
                    </div>
                    <div id="packagingContent"></div>
                </div>

                <div class="content-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                        <h3 style="margin:0;">Packaging Reports</h3>
                        <input id="packagingHistorySearch" placeholder="Search all packaging" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:240px" oninput="app.renderPackagingReports()">
                    </div>
                    <div id="packagingReportsContainer" style="overflow-x:auto;"><p style="color:#777;">No data yet</p></div>
                </div>

                <div class="content-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
                        <h3 style="margin:0;">Packaging Master Report</h3>
                        <small style="color:#666;">Filter full history and export to CSV</small>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Start Date</label>
                            <input type="date" id="packagingFilterStart" onchange="app.renderPackagingMasterReport()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">End Date</label>
                            <input type="date" id="packagingFilterEnd" onchange="app.renderPackagingMasterReport()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Category</label>
                            <select id="packagingFilterCategory" onchange="app.renderPackagingMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="">All categories</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Item</label>
                            <select id="packagingFilterItem" onchange="app.renderPackagingMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:200px;">
                                <option value="">All items</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Shift</label>
                            <select id="packagingFilterShift" onchange="app.renderPackagingMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="">All shifts</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Sort By</label>
                            <select id="packagingSortBy" onchange="app.renderPackagingMasterReport()" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;">
                                <option value="dateDesc">Date (Newest)</option>
                                <option value="dateAsc">Date (Oldest)</option>
                                <option value="category">Category</option>
                                <option value="item">Item</option>
                                <option value="shift">Shift</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:10px;align-items:flex-end;">
                            <button class="btn btn-secondary" onclick="app.exportPackagingMasterReport()">Export CSV</button>
                        </div>
                    </div>
                    <div style="margin-top:15px;font-weight:600;color:#444;">
                        <span id="packagingMasterCount">0 records</span>
                    </div>
                    <div id="packagingMasterTable" style="margin-top:12px;overflow-x:auto;"></div>
                </div>
            </div>
            
            <!-- STOCK PAGE -->
            <div class="page" id="stockPage" style="display:none;">
                <div class="page-header">
                    <h2>Stock</h2>
                    <p>Manage stock items and transactions</p>
                </div>

                <div class="content-card">
                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                        <input type="file" id="stockImportFile" accept=".xlsx,.xls,.csv" onchange="app.handleStockImport(event)">
                        <small style="color:#666">Import Excel (.xlsx/.xls) or CSV with headers: code,name,group,unit,qty,reorder</small>
                    </div>
                    <div id="stockContent"></div>
                </div>
            </div>

            <!-- STOCK EDITOR PAGE -->
            <div class="page" id="stockEditorPage" style="display:none;">
                <div class="page-header">
                    <h2 id="stockEditorTitle">Create Item</h2>
                    <p id="stockEditorSubtitle">Define inventory details and bill of materials</p>
                </div>

                <div class="content-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
                        <button class="btn btn-secondary" style="width:auto;padding:10px 18px;" onclick="app.cancelStockEdit()">‚Üê Back to Stock</button>
                        <div id="stockEditorMeta" style="font-size:13px;color:#777;"></div>
                    </div>

                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px;">
                        <div class="form-group">
                            <label>Code</label>
                            <input type="text" id="modalStockCode" placeholder="Item code">
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="modalStockName" placeholder="Item name">
                        </div>
                        <div class="form-group">
                            <label>Group/Category</label>
                            <select id="modalStockGroup" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                <option value="">-- Select Category --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unit of Measure</label>
                            <select id="modalStockUnit" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                <option value="pcs">Unite (pcs)</option>
                                <option value="gram">Gram</option>
                                <option value="kg">KG</option>
                                <option value="l">L</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="modalStockQty" value="0">
                        </div>
                        <div class="form-group">
                            <label>Reorder Level</label>
                            <input type="number" id="modalStockReorder" placeholder="Reorder threshold">
                        </div>
                        <div class="form-group" style="grid-column: span 3;">
                            <label style="display:block;margin-bottom:6px;font-weight:600;">Product Flags</label>
                            <div style="display:flex;flex-wrap:wrap;gap:18px;font-size:14px;">
                                <label style="display:flex;align-items:center;gap:6px;">
                                    <input type="checkbox" id="stockFlagSell">
                                    <span>Can Be Sold</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;">
                                    <input type="checkbox" id="stockFlagSemi">
                                    <span>Semi Product</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;">
                                    <input type="checkbox" id="stockFlagPack">
                                    <span>Pack</span>
                                </label>
                            </div>
                            <div id="packDetails" style="display:none;margin-top:12px;padding:12px;border:1px dashed #ccc;border-radius:8px;background:#fafafa;">
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                                    <div>
                                        <label style="display:block;margin-bottom:6px;font-weight:600;">Pack Item</label>
                                        <select id="packItemSelect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                            <option value="">-- Select Item --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:6px;font-weight:600;">Quantity Inside Pack</label>
                                        <input type="number" id="packItemQuantity" min="1" value="1" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    </div>
                                </div>
                                <p style="margin-top:10px;font-size:12px;color:#777;">Specify which item this pack contains and how many units are inside.</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><strong>Bill of Materials (BOM)</strong></label>
                        <div id="bomList" style="border:1px solid #ddd; padding:10px; border-radius:6px; margin-bottom:10px; min-height:60px;"></div>
                        <button type="button" class="btn btn-secondary" style="width:auto;padding:10px 18px;" onclick="app.addBomRow()">+ Add Material</button>
                    </div>

                    <div style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-top:25px;">
                        <button class="btn btn-secondary" style="width:auto;padding:10px 18px;" onclick="app.cancelStockEdit()">Cancel</button>
                        <button class="btn btn-primary" style="width:auto;padding:10px 18px;" onclick="app.saveStockItem()">Save Item</button>
                    </div>
                </div>
            </div>

            <!-- REPORTS PAGE -->
            <div class="page" id="reportsPage" style="display:none;">
                <div class="page-header">
                    <h2>Reports</h2>
                    <p>Stock and Orders reports</p>
                </div>

                <div class="content-card">
                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                        <button class="btn btn-secondary" onclick="app.exportStockItems()">Export Stock CSV</button>
                        <button class="btn btn-secondary" onclick="app.exportStockTransactions()">Export Transactions CSV</button>
                        <button class="btn btn-secondary" onclick="app.exportOrders()">Export Orders CSV</button>
                        <div style="flex:1"></div>
                        <input id="reportSearch" placeholder="Search reports" style="padding:8px;border:1px solid #ddd;border-radius:8px;width:300px" oninput="app.renderReports()">
                    </div>

                    <div id="reportsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- USER MODAL -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add New User</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="modalUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="modalEmail" placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="modalPassword" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="modalRole" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="staff">Staff</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>
                <div style="margin-top:15px;padding:12px;border:1px dashed #cbd5e1;border-radius:8px;background:#f8fbff;font-size:13px;color:#445366;">
                    Detailed access can now be configured per user from the Permissions page after creating the account.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveUser()">Save User</button>
            </div>
        </div>
    </div>

    <!-- CATEGORY MODAL -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Create Category</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="modalCategoryName" placeholder="e.g., RM, FG, Packaging">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="modalCategoryDesc" placeholder="Description">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeCategoryModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveCategory()">Save Category</button>
            </div>
        </div>
    </div>

    <!-- CUSTOMER MODAL -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Create Customer</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="modalCustomerName" placeholder="Customer name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="modalCustomerEmail" placeholder="Email (optional)">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="modalCustomerPhone" placeholder="Phone (optional)">
                </div>
                <div style="margin-top:12px">
                    <label style="font-weight:600">Allowed Products</label>
                    <div id="customerAllowedProducts" style="margin-top:8px"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeCustomerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- ORDER EDIT MODAL -->
    <div class="modal" id="orderEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Order</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="editOrderCustomer" placeholder="Customer name">
                </div>
                <div style="margin-top:15px;margin-bottom:15px;">
                    <label style="font-weight:600">Line Items</label>
                    <div id="editOrderLineItems" style="margin:10px 0"></div>
                    <button class="btn btn-secondary" onclick="app.addEditOrderLineItem()" style="width:100%;margin-top:10px">+ Add Item</button>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editOrderNotes" placeholder="Order notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeOrderEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveOrderEdit()">Save Order</button>
            </div>
        </div>
    </div>

    <!-- ORDER DETAIL MODAL -->
    <div class="modal" id="orderDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="orderDetailTitle">Order Details</h3>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:15px">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
                        <div>
                            <label style="font-size:12px;color:#666">Order ID</label>
                            <p id="detailOrderId" style="font-size:16px;font-weight:600"></p>
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666">Customer</label>
                            <p id="detailCustomer" style="font-size:16px;font-weight:600"></p>
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666">Date</label>
                            <p id="detailDate" style="font-size:14px"></p>
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666">Status</label>
                            <p id="detailStatus" style="font-size:14px"></p>
                        </div>
                    </div>

                    <div style="margin:15px 0;border-top:1px solid #e0e0e0;padding-top:15px">
                        <h4 style="margin-bottom:10px">Line Items</h4>
                        <table class="table" style="margin-bottom:15px">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody id="detailLineItems"></tbody>
                        </table>
                    </div>

                    <div style="margin:15px 0;border-top:1px solid #e0e0e0;padding-top:15px">
                        <label style="font-size:12px;color:#666;font-weight:600">Notes</label>
                        <p id="detailNotes" style="font-size:14px;color:#666;margin-top:5px"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeOrderDetailModal()">Close</button>
                <button class="btn btn-primary" id="editOrderBtn" style="display:none;margin-right:8px">‚úèÔ∏è Edit</button>
                <button class="btn btn-warning" id="approveOrderBtn" style="display:none;margin-right:8px">Approve</button>
                <button class="btn btn-delete" id="rejectOrderBtn" style="display:none;margin-right:8px">Reject</button>
                <button class="btn btn-primary" onclick="app.printOrder()">üñ®Ô∏è Print</button>
            </div>
        </div>
    </div>

    <!-- TRANSFER MODAL -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transferModalTitle">Stock Transfer</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer / Destination</label>
                    <input type="text" id="transferCustomer" placeholder="Customer name or destination">
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="transferItem" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px"></select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="transferQty" value="1">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="transferNotes" placeholder="Optional notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="transferDate" value="">
                </div>
                <div class="form-group">
                    <label>Reference</label>
                    <input type="text" id="transferRef" placeholder="Ref # (optional)">
                </div>
                <div class="form-group">
                    <label>Advanced</label>
                    <div style="font-size:13px;color:#666">You can add transfer type, destination warehouse, and auto-create order (pro features)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeTransferModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.performTransfer()">Confirm Transfer</button>
            </div>
        </div>
    </div>

    <!-- OPERATION MODAL -->
    <div class="modal" id="operationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="operationModalTitle">Add Operation</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Cart Number</label>
                    <input type="text" id="modalOperationCart" placeholder="Enter cart number">
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="modalOperationTime">
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="modalOperationItem" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        <option value="">Select an item</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="modalOperationQuantity" placeholder="Quantity" min="0">
                </div>
                <div class="form-group">
                    <label>Scrap</label>
                    <input type="number" id="modalOperationScrap" placeholder="Scrap amount" min="0">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modalOperationNotes" placeholder="Notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeOperationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveOperation()">Save Operation</button>
            </div>
        </div>
    </div>

    <!-- PACKAGING MODAL -->
    <div class="modal" id="packagingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="packagingModalTitle">Add Packaging</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Cart Number</label>
                    <input type="text" id="modalPackagingCart" placeholder="Enter cart number">
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="modalPackagingTime">
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="modalPackagingItem" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        <option value="">Select an item</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="modalPackagingQuantity" placeholder="Quantity" min="0">
                </div>
                <div class="form-group">
                    <label>Scrap</label>
                    <input type="number" id="modalPackagingScrap" placeholder="Scrap amount" min="0">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modalPackagingNotes" placeholder="Notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closePackagingModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.savePackaging()">Save Packaging</button>
            </div>
        </div>
    </div>

    <!-- PRODUCTION MODAL -->
    <div class="modal" id="productionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productionModalTitle">Record Production</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Item</label>
                    <select id="modalProductionItem" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;" onchange="app.updateProductionDisplay(parseInt(this.value))">
                        <option value="">Select an item</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;padding:12px;background:#f5f5f5;border-radius:8px;">
                    <div>
                        <label style="font-size:12px;color:#666">Required Qty</label>
                        <p id="productionRequired" style="font-size:18px;font-weight:600">0</p>
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666">Already Produced</label>
                        <p id="productionProduced" style="font-size:18px;font-weight:600">0</p>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;padding:12px;background:#fff3cd;border-radius:8px;">
                    <div>
                        <label style="font-size:12px;color:#666">Remaining to Produce</label>
                        <p id="productionRemaining" style="font-size:18px;font-weight:600;color:#856404">0</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Produced Quantity</label>
                    <input type="number" id="modalProductionQuantity" placeholder="How much did you produce?" min="0">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modalProductionNotes" placeholder="Production notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeProductionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveProduction()">Save Production</button>
            </div>
        </div>
    </div>

    <!-- ORDER MODAL -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="orderModalTitle">Create Order</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="orderCustomer" placeholder="Customer name">
                </div>
                <div style="margin-top:15px;margin-bottom:15px;">
                    <label style="font-weight:600">Line Items</label>
                    <div id="orderLineItems" style="margin:10px 0"></div>
                    <button class="btn btn-secondary" onclick="app.addOrderLineItem()" style="width:100%;margin-top:10px">+ Add Item</button>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="orderNotes" placeholder="Order notes" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeOrderModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.performOrder()">Create Order</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATIONS CONTAINER -->
    <div id="notificationsContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase (compat) for easy inline integration -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase config - used by app initialization
        window.FIREBASE_CONFIG = {
            apiKey: "AIzaSyAknz4IdGfPai8lRpLE-nGipVrrmnah0Vo",
            authDomain: "vwbp-2ec7c.firebaseapp.com",
            projectId: "vwbp-2ec7c",
            storageBucket: "vwbp-2ec7c.firebasestorage.app",
            messagingSenderId: "611486328090",
            appId: "1:611486328090:web:a46deef21762489aeb78a3"
        };
        console.log('‚úÖ Firebase config loaded:', window.FIREBASE_CONFIG.projectId);
    </script>
    <script>
        class BakeryApp {
            constructor() {
                // default demo users to allow login if storage is empty
                this.users = [
                    { id: 1, username: 'admin', password: 'admin123', email: 'admin@example.com', role: 'admin', status: 'active', created: new Date().toISOString().split('T')[0], permissions: ['dashboard','users','products','orders','inventory','permissions','categories'] },
                    { id: 2, username: 'manager', password: 'manager123', email: 'manager@example.com', role: 'manager', status: 'active', created: new Date().toISOString().split('T')[0], permissions: ['dashboard','products','orders','inventory','categories'] },
                    { id: 3, username: 'staff', password: 'staff123', email: 'staff@example.com', role: 'staff', status: 'active', created: new Date().toISOString().split('T')[0], permissions: ['dashboard','orders'] },
                    { id: 4, username: 'cust1', password: 'cust123', email: 'cust1@example.com', role: 'customer', status: 'active', created: new Date().toISOString().split('T')[0], permissions: [] }
                ];
                this.currentUser = null;

                // Default permissions and sample data
                this.rolePermissionDefaults = {
                    admin: ['dashboard','users','customers','categories','stock','inventory','products','orders','manufacturing','production','operation','packaging','reports','permissions','logistic','settings','menu','website','shop'],
                    manager: ['dashboard','customers','stock','products','orders','manufacturing','production','operation','packaging','reports','logistic','shop'],
                    staff: ['dashboard','orders','operation','packaging'],
                    customer: ['shop']
                };

                this.permissionCatalog = {
                    dashboard: { label: 'Dashboard', icon: 'üìä', description: 'KPIs and shortcuts', features: [] },
                    users: { label: 'Users', icon: 'üë•', description: 'Manage staff accounts', features: [] },
                    customers: { label: 'Customers', icon: 'üè∑', description: 'Customer records', features: [] },
                    categories: { label: 'Categories', icon: 'üìÇ', description: 'Item grouping', features: [] },
                    stock: { label: 'Stock', icon: 'üì¶', description: 'Inventory master data', features: [] },
                    products: { label: 'Products', icon: 'ü•ê', description: 'Sellable items', features: [] },
                    inventory: { label: 'Inventory', icon: 'üßæ', description: 'Warehouse snapshot', features: [] },
                    orders: { label: 'Orders', icon: 'üì¶', description: 'Sales pipeline', features: [] },
                    manufacturing: { label: 'Manufacturing', icon: 'üè≠', description: 'BOM conversions', features: [] },
                    production: {
                        label: 'Production',
                        icon: 'üè≠',
                        description: 'Plan & track batches',
                        features: [
                            { key: 'planBoard', label: 'Production tracker' },
                            { key: 'archiveHistory', label: 'Archive history' },
                            { key: 'masterReport', label: 'Master report' }
                        ]
                    },
                    operation: {
                        label: 'Operation',
                        icon: '‚öôÔ∏è',
                        description: 'Daily shop-floor activities',
                        features: [
                            { key: 'shiftInput', label: 'Shift input' },
                            { key: 'historySearch', label: 'History search' },
                            { key: 'masterReport', label: 'Master report' },
                            { key: 'exportTools', label: 'Export tools' }
                        ]
                    },
                    packaging: {
                        label: 'Packaging',
                        icon: 'üì¶',
                        description: 'Packaging operations',
                        features: [
                            { key: 'entryTable', label: 'Entry table' },
                            { key: 'historyReports', label: 'History reports' },
                            { key: 'masterReport', label: 'Master report' }
                        ]
                    },
                    reports: { label: 'Reports', icon: 'üìä', description: 'Exports & analytics', features: [] },
                    permissions: { label: 'Permissions', icon: 'üîê', description: 'Role & feature access', features: [] },
                    logistic: { label: 'Logistic', icon: 'üöö', description: 'Delivery tracking', features: [] },
                    settings: { label: 'Settings', icon: '‚öôÔ∏è', description: 'System preferences', features: [] },
                    menu: { label: 'Menu', icon: 'üìñ', description: 'Menu builder', features: [] },
                    website: { label: 'Website', icon: 'üåê', description: 'Website content', features: [] },
                    shop: { label: 'Shop', icon: 'üõí', description: 'Customer storefront', features: [] }
                };

                this.pagePermissionMap = {
                    dashboard: 'dashboard',
                    users: 'users',
                    customers: 'customers',
                    categories: 'categories',
                    permissions: 'permissions',
                    products: 'products',
                    orders: 'orders',
                    inventory: 'inventory',
                    stock: 'stock',
                    reports: 'reports',
                    manufacturing: 'manufacturing',
                    production: 'production',
                    operation: 'operation',
                    packaging: 'packaging',
                    logistic: 'logistic',
                    settings: 'settings',
                    menu: 'menu',
                    website: 'website',
                    shop: 'shop'
                };

                this.activePermissionUserId = null;

                this.products = [
                    { id: 1, name: 'Croissant', price: 3.50, stock: 50 },
                    { id: 2, name: 'Baguette', price: 2.50, stock: 80 },
                    { id: 3, name: 'Sourdough', price: 4.00, stock: 40 }
                ];

                this.orders = [
                    { id: 1, customer: 'John Doe', lineItems: [{itemId: 1, qty: 2, notes: ''}], date: '2025-01-20', status: 'completed', notes: '' },
                    { id: 2, customer: 'Jane Smith', lineItems: [{itemId: 2, qty: 3, notes: ''}], date: '2025-01-20', status: 'pending', notes: '' }
                ];
                this.odooRequirements = [];
                this.odooImportMeta = null;

                // Customers
                this.customers = [
                    { id: 1, name: 'John Doe', email: 'john@example.com', phone: '', allowedProducts: [1,2], created: '2025-01-01' },
                    { id: 2, name: 'Jane Smith', email: 'jane@example.com', phone: '', allowedProducts: [2], created: '2025-01-05' }
                ];

                // Categories for stock items
                this.categories = [
                    { id: 1, name: 'RM', description: 'Raw Materials' },
                    { id: 2, name: 'FG', description: 'Finished Goods' },
                    { id: 3, name: 'Packaging', description: 'Packaging Materials' }
                ];

                // Stock items and transactions
                this.stockItems = [
                    { id: 1, name: 'Flour (kg)', code: 'FLR-001', group: 'RM', unit: 'kg', qty: 120, reorder: 20, created: '2025-01-01', canBeSold: false, isSemiProduct: false, isPack: false },
                    { id: 2, name: 'Butter (kg)', code: 'BUT-001', group: 'RM', unit: 'kg', qty: 40, reorder: 10, created: '2025-01-02', canBeSold: false, isSemiProduct: false, isPack: false }
                ];

                this.stockTransactions = [
                    { id: 1, itemId: 1, type: 'in', qty: 100, date: '2025-01-05', note: 'Initial stock' },
                    { id: 2, itemId: 2, type: 'in', qty: 40, date: '2025-01-05', note: 'Initial stock' }
                ];

                // Operations, packaging, production, manufacturing
                this.operations = [];
                this.packaging = [];
                this.production = [];
                this.manufacturingRuns = [];
                this.productionArchives = [];
                this.currentManufacturingPlan = null;
                this.activeOperationSection = 'shift';
                this.operationShiftMeta = { id: 0, startedAt: null, endedAt: null };
                this.editingStockId = null;

                this.loadFromStorage();
                if (!this.operationShiftMeta) {
                    this.operationShiftMeta = { id: 0, startedAt: null, endedAt: null };
                }
                this.ensureAllUserPermissionDefaults();
                this.setupRealtimeSync();
                this.initializeRememberMe();
                this.instanceId = this.getOrCreateInstanceId();
                this.initializeCloudSync();
            }
                getOrCreateInstanceId() {
                    let id = localStorage.getItem('bakeryInstanceId');
                    if (!id) {
                        id = 'inst_' + Math.random().toString(36).slice(2) + '_' + Date.now();
                        localStorage.setItem('bakeryInstanceId', id);
                    }
                    return id;
                }
                logout() {
                    this.currentUser = null;
                    this.clearRememberedSession();
                    document.getElementById('modulesPage').classList.remove('active');
                    document.getElementById('dashboard').classList.remove('active');
                    document.getElementById('loginPage').style.display = 'flex';
                    this.showTopNav(false);
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                    this.applyRememberedLoginUI();
                    this.showNotification('Logged out successfully', 'success');
                }

            loadFromStorage() {
                const stored = localStorage.getItem('bakeryAppData');
                if (stored) {
                    const data = JSON.parse(stored);
                    this.users = data.users || this.users;
                    this.products = data.products || this.products;
                    this.orders = data.orders || this.orders;
                    this.stockItems = data.stockItems || this.stockItems;
                    this.stockTransactions = data.stockTransactions || this.stockTransactions;
                    this.customers = data.customers || this.customers;
                    this.operations = data.operations || this.operations;
                    this.packaging = data.packaging || this.packaging;
                    this.production = data.production || this.production;
                    this.categories = data.categories || this.categories;
                    this.manufacturingRuns = data.manufacturingRuns || this.manufacturingRuns;
                    this.odooRequirements = data.odooRequirements || this.odooRequirements;
                    this.odooImportMeta = data.odooImportMeta || this.odooImportMeta;
                    this.productionArchives = data.productionArchives || this.productionArchives;
                    this.operationShiftMeta = data.operationShiftMeta || this.operationShiftMeta;
                }
                this.ensureAdminAccount();
                this.ensureAllUserPermissionDefaults();
            }

            ensureAdminAccount(options = {}) {
                const forcePassword = !!options.forcePassword;
                if (!Array.isArray(this.users)) this.users = [];

                const adminDefaults = (this.rolePermissionDefaults && this.rolePermissionDefaults.admin)
                    ? this.rolePermissionDefaults.admin.slice()
                    : [];
                const today = new Date().toISOString().split('T')[0];
                const template = {
                    username: 'admin',
                    password: 'admin123',
                    email: 'admin@example.com',
                    role: 'admin',
                    status: 'active',
                    created: today,
                    permissions: adminDefaults
                };

                const nextUserId = () => {
                    const ids = this.users.map(u => Number(u.id) || 0);
                    return ids.length ? Math.max(...ids) + 1 : 1;
                };

                let admin = this.users.find(u => u.username === template.username);
                let updated = false;

                if (!admin) {
                    admin = Object.assign({ id: nextUserId() }, template);
                    this.users.push(admin);
                    updated = true;
                } else {
                    if ((forcePassword || !admin.password) && admin.password !== template.password) {
                        admin.password = template.password;
                        updated = true;
                    }
                    if (admin.role !== template.role) {
                        admin.role = template.role;
                        updated = true;
                    }
                    if (!admin.status) {
                        admin.status = template.status;
                        updated = true;
                    }
                    if (!admin.email) {
                        admin.email = template.email;
                        updated = true;
                    }
                    if (!admin.created) {
                        admin.created = template.created;
                        updated = true;
                    }
                    if (!Array.isArray(admin.permissions) || !admin.permissions.length) {
                        admin.permissions = adminDefaults.slice();
                        updated = true;
                    }
                }

                this.ensureUserPermissionDefaultsForUser(admin);

                if (updated && typeof this.saveToStorage === 'function') {
                    this.saveToStorage();
                }

                return admin;
            }

            saveToStorage() {
                localStorage.setItem('bakeryAppData', JSON.stringify({
                    users: this.users,
                    products: this.products,
                    orders: this.orders
                    , stockItems: this.stockItems,
                    stockTransactions: this.stockTransactions
                    , customers: this.customers
                    , operations: this.operations
                    , packaging: this.packaging
                    , production: this.production
                    , categories: this.categories
                    , manufacturingRuns: this.manufacturingRuns
                    , odooRequirements: this.odooRequirements
                    , odooImportMeta: this.odooImportMeta
                    , productionArchives: this.productionArchives
                    , operationShiftMeta: this.operationShiftMeta
                }));
                this.broadcastUpdate();
                if (!this._skipNextCloudPush) {
                    this.pushCloudUpdateSafe();
                } else {
                    this._skipNextCloudPush = false;
                }
            }

            setupRealtimeSync() {
                window.addEventListener('storage', (e) => {
                    if (e.key === 'bakeryAppData') {
                        this.loadFromStorage();
                        this.refreshCurrentPage();
                        this.showNotification('Data updated from another tab', 'info');
                    }
                });
            }

            broadcastUpdate() {
                window.dispatchEvent(new Event('bakeryDataChanged'));
            }

            /* ===== Cloud Sync (Firebase Firestore) ===== */
            initializeCloudSync() {
                try {
                    console.log('üî• Cloud sync init start');
                    if (!window.FIREBASE_CONFIG || !window.FIREBASE_CONFIG.projectId) {
                        console.warn('‚ùå FIREBASE_CONFIG missing or no projectId');
                        this._cloud = { enabled: false };
                        return;
                    }
                    console.log('‚úÖ FIREBASE_CONFIG found:', window.FIREBASE_CONFIG.projectId);
                    if (typeof firebase === 'undefined') {
                        console.warn('‚ùå Firebase SDK not loaded');
                        this._cloud = { enabled: false };
                        return;
                    }
                    console.log('‚úÖ Firebase SDK loaded');
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.FIREBASE_CONFIG);
                        console.log('‚úÖ Firebase app initialized');
                    }
                    const db = firebase.firestore();
                    const docRef = db.collection('tenants').doc('default');
                    this._cloud = { enabled: true, db, docRef, unsub: null };
                    console.log('‚úÖ Firestore db connected');

                    // Start listener
                    this._cloud.unsub = docRef.onSnapshot((snap) => {
                        console.log('üîî Cloud listener triggered, exists:', snap.exists);
                        if (!snap.exists) return;
                        const payload = snap.data() || {};
                        if (payload.lastWriteBy && payload.lastWriteBy === this.instanceId) return;
                        if (payload.appData) {
                            try {
                                localStorage.setItem('bakeryAppData', JSON.stringify(payload.appData));
                                this._skipNextCloudPush = true; // avoid echo
                                this.loadFromStorage();
                                this.refreshCurrentPage();
                                console.log('‚úÖ Cloud sync applied');
                            } catch (e) {
                                console.warn('Cloud sync apply failed', e);
                            }
                        }
                    }, (err) => console.warn('‚òÅÔ∏è Cloud listener error', err));

                    // Ensure doc exists on first run
                    docRef.get().then((d) => {
                        if (!d.exists) {
                            console.log('üìù Doc does not exist, creating...');
                            this.pushCloudUpdateSafe(true);
                        } else {
                            console.log('‚úÖ Doc exists');
                        }
                    }).catch((err)=>{
                        console.warn('Error checking doc:', err);
                    });
                } catch (err) {
                    console.warn('Failed to initialize cloud sync', err);
                    this._cloud = { enabled: false };
                }
            }

            pushCloudUpdateSafe(force = false) {
                if (!this._cloud || !this._cloud.enabled || !this._cloud.docRef) {
                    console.warn('‚ùå Cloud not ready, skipping push');
                    return;
                }
                try {
                    const state = {
                        users: this.users,
                        products: this.products,
                        orders: this.orders,
                        stockItems: this.stockItems,
                        stockTransactions: this.stockTransactions,
                        customers: this.customers,
                        operations: this.operations,
                        packaging: this.packaging,
                        production: this.production,
                        categories: this.categories,
                        manufacturingRuns: this.manufacturingRuns,
                        odooRequirements: this.odooRequirements,
                        odooImportMeta: this.odooImportMeta,
                        productionArchives: this.productionArchives,
                        operationShiftMeta: this.operationShiftMeta
                    };
                    console.log('üì§ Pushing to Firebase...');
                    this._cloud.docRef.set({
                        appData: state,
                        lastWriteBy: this.instanceId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true }).then(() => {
                        console.log('‚úÖ Firebase push successful');
                    }).catch(err => {
                        console.warn('‚ùå Cloud push failed', err.message);
                    });
                } catch (e) {
                    console.warn('pushCloudUpdateSafe error', e);
                }
            }

            initializeRememberMe() {
                this.applyRememberedLoginUI();
                this.autoLoginRememberedSession();
            }

            getRememberedLoginRecord() {
                const raw = localStorage.getItem('bakeryRememberedLogin');
                if (!raw) return null;
                try {
                    const parsed = JSON.parse(raw);
                    return parsed && parsed.username ? parsed : null;
                } catch (err) {
                    console.warn('Failed to parse remembered login', err);
                    localStorage.removeItem('bakeryRememberedLogin');
                    return null;
                }
            }

            setRememberedLogin(username) {
                if (!username) {
                    this.clearRememberedLogin();
                    return;
                }
                localStorage.setItem('bakeryRememberedLogin', JSON.stringify({ username, remember: true, ts: Date.now() }));
            }

            clearRememberedLogin() {
                localStorage.removeItem('bakeryRememberedLogin');
            }

            applyRememberedLoginUI() {
                const remembered = this.getRememberedLoginRecord();
                const usernameInput = document.getElementById('loginUsername');
                const rememberCheckbox = document.getElementById('rememberMe');
                if (usernameInput && remembered?.username) {
                    usernameInput.value = remembered.username;
                }
                if (rememberCheckbox) {
                    rememberCheckbox.checked = !!remembered;
                }
            }

            persistRememberedSession(username) {
                if (!username) return;
                localStorage.setItem('bakeryRememberedSession', JSON.stringify({ username, ts: Date.now() }));
            }

            clearRememberedSession() {
                localStorage.removeItem('bakeryRememberedSession');
            }

            autoLoginRememberedSession() {
                if (this.currentUser) return;
                const raw = localStorage.getItem('bakeryRememberedSession');
                if (!raw) return;
                try {
                    const session = JSON.parse(raw);
                    if (!session?.username) throw new Error('Invalid session payload');
                    const user = (this.users || []).find(u => u.username === session.username);
                    if (!user) throw new Error('User not found');
                    this.ensureUserPermissionDefaultsForUser(user);
                    this.currentUser = user;
                    this.showNotification(`Welcome back, ${user.username}!`, 'success');
                    this.showModulesPage();
                    this.logActivity(`${user.username} auto-logged in (remember me)`);
                    this.applyNavPermissionVisibility();
                } catch (err) {
                    console.warn('Failed to restore remembered session', err);
                    this.clearRememberedSession();
                }
            }

            ensureAllUserPermissionDefaults() {
                (this.users || []).forEach(user => this.ensureUserPermissionDefaultsForUser(user));
            }

            ensureUserPermissionDefaultsForUser(user) {
                if (!user) return;
                if (!user.modulePermissions || typeof user.modulePermissions !== 'object') {
                    user.modulePermissions = {};
                }
                if (!user.featurePermissions || typeof user.featurePermissions !== 'object') {
                    user.featurePermissions = {};
                }
                const legacy = Array.isArray(user.permissions) ? user.permissions : null;
                const defaults = legacy || this.rolePermissionDefaults[user.role] || [];
                Object.keys(this.permissionCatalog).forEach(moduleKey => {
                    if (typeof user.modulePermissions[moduleKey] === 'undefined') {
                        user.modulePermissions[moduleKey] = defaults.includes(moduleKey);
                    }
                    if (!user.featurePermissions[moduleKey]) {
                        user.featurePermissions[moduleKey] = {};
                    }
                    const featureList = this.permissionCatalog[moduleKey].features || [];
                    featureList.forEach(feature => {
                        if (typeof user.featurePermissions[moduleKey][feature.key] === 'undefined') {
                            user.featurePermissions[moduleKey][feature.key] = user.modulePermissions[moduleKey];
                        }
                    });
                });
            }

            selectPermissionUser(userId) {
                const parsed = parseInt(userId, 10);
                if (isNaN(parsed)) return;
                this.activePermissionUserId = parsed;
                this.renderPermissions();
            }

            toggleUserModulePermission(userId, moduleKey, enabled) {
                const parsedId = parseInt(userId, 10);
                const target = (this.users || []).find(u => u.id === parsedId);
                if (!target) return;
                this.ensureUserPermissionDefaultsForUser(target);
                target.modulePermissions[moduleKey] = !!enabled;
                const featureList = this.permissionCatalog[moduleKey]?.features || [];
                featureList.forEach(feature => {
                    target.featurePermissions[moduleKey][feature.key] = !!enabled;
                });
                target.permissionsUpdatedAt = new Date().toISOString();
                this.saveToStorage();
                if (this.currentUser && this.currentUser.id === target.id) {
                    this.applyNavPermissionVisibility();
                    this.renderModulesGrid();
                    if (moduleKey === 'operation') this.renderOperation();
                    if (moduleKey === 'packaging') this.renderPackaging();
                    if (moduleKey === 'production') this.renderProduction();
                    if (!enabled) {
                        const activePageEl = document.querySelector('.page.active');
                        const activePageId = activePageEl ? activePageEl.id.replace('Page','') : null;
                        if (activePageId === moduleKey) {
                            const fallback = this.getFirstAllowedPageName();
                            if (fallback) {
                                this.showPage(fallback);
                            }
                        }
                    }
                }
                this.renderPermissions();
                this.showNotification(`Updated ${moduleKey} access for ${target.username}`, 'success');
            }

            toggleUserFeaturePermission(userId, moduleKey, featureKey, enabled) {
                const parsedId = parseInt(userId, 10);
                const target = (this.users || []).find(u => u.id === parsedId);
                if (!target) return;
                this.ensureUserPermissionDefaultsForUser(target);
                if (!target.featurePermissions[moduleKey]) {
                    target.featurePermissions[moduleKey] = {};
                }
                target.featurePermissions[moduleKey][featureKey] = !!enabled;
                target.permissionsUpdatedAt = new Date().toISOString();
                this.saveToStorage();
                if (this.currentUser && this.currentUser.id === target.id) {
                    if (moduleKey === 'operation') this.renderOperation();
                    if (moduleKey === 'packaging') this.renderPackaging();
                    if (moduleKey === 'production') this.renderProduction();
                }
                this.renderPermissions();
                this.showNotification(`Updated ${featureKey} access for ${target.username}`, 'success');
            }

            hasModuleAccess(moduleKey, user = this.currentUser) {
                if (!moduleKey) return true;
                if (!user) return true;
                this.ensureUserPermissionDefaultsForUser(user);
                if (!this.permissionCatalog[moduleKey]) return true;
                return !!user.modulePermissions[moduleKey];
            }

            hasFeatureAccess(moduleKey, featureKey, user = this.currentUser) {
                if (!this.hasModuleAccess(moduleKey, user)) return false;
                if (!featureKey) return true;
                const featureMap = (user?.featurePermissions || {})[moduleKey] || {};
                if (typeof featureMap[featureKey] === 'boolean') {
                    return featureMap[featureKey];
                }
                return true;
            }

            applyNavPermissionVisibility() {
                document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                    const page = item.dataset.page;
                    const moduleKey = this.pagePermissionMap[page] || page;
                    const allowed = this.hasModuleAccess(moduleKey);
                    item.style.display = allowed ? 'block' : 'none';
                });
            }

            getFirstAllowedPageName() {
                const pages = Object.keys(this.pagePermissionMap);
                for (let i = 0; i < pages.length; i += 1) {
                    const page = pages[i];
                    const moduleKey = this.pagePermissionMap[page] || page;
                    if (this.hasModuleAccess(moduleKey)) {
                        return page;
                    }
                }
                return null;
            }

            login() {
                const username = (document.getElementById('loginUsername').value || '').trim();
                const password = (document.getElementById('loginPassword').value || '').trim();

                if (!username || !password) {
                    this.showNotification('Please enter username and password', 'error');
                    return;
                }

                const user = this.users.find(u => u.username === username && u.password === password);

                if (user) {
                    this.ensureUserPermissionDefaultsForUser(user);
                    this.currentUser = user;
                    this.showNotification(`Welcome, ${user.username}!`, 'success');
                    this.showModulesPage();
                    this.logActivity(`${user.username} logged in`);
                    this.applyNavPermissionVisibility();
                    const remember = document.getElementById('rememberMe')?.checked;
                    if (remember) {
                        this.setRememberedLogin(user.username);
                        this.persistRememberedSession(user.username);
                    } else {
                        this.clearRememberedLogin();
                        this.clearRememberedSession();
                    }
                } else {
                    this.showNotification('Invalid credentials', 'error');
                }
            }

            showModulesPage() {     
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('modulesPage').classList.add('active');
                document.getElementById('dashboard').classList.remove('active');
                this.showTopNav(true);
                
                document.getElementById('modulesUserName').textContent = this.currentUser.username;
                document.getElementById('modulesUserRole').textContent = 'Role: ' + this.currentUser.role.toUpperCase();
                
                this.renderModulesGrid();
            }

            renderModulesGrid() {
                const modules = [
                    { id: 'customers', name: 'Customers', icon: 'üè∑', desc: 'Manage customers' },
                    { id: 'stock', name: 'Stock', icon: 'üì¶', desc: 'Manage inventory' },
                    { id: 'orders', name: 'Orders', icon: 'üìã', desc: 'Handle orders' },
                    { id: 'manufacturing', name: 'Manufacturing', icon: 'üè≠', desc: 'Manufacture products' },
                    { id: 'production', name: 'Production', icon: 'üè≠', desc: 'Production planning' },
                    { id: 'operation', name: 'Operation', icon: '‚öôÔ∏è', desc: 'Daily operations' },
                    { id: 'packaging', name: 'Packaging', icon: 'üì¶', desc: 'Packaging management' },
                    { id: 'logistic', name: 'Logistic', icon: 'üöö', desc: 'Delivery tracking' },
                    { id: 'settings', name: 'Settings', icon: '‚öôÔ∏è', desc: 'System settings' },
                    { id: 'menu', name: 'Menu', icon: 'üìñ', desc: 'Menu management' },
                    { id: 'website', name: 'Website', icon: 'üåê', desc: 'Website content' },
                    { id: 'shop', name: 'Shop', icon: 'üõí', desc: 'Online shop' }
                ];

                // Filter modules based on current user role
                const role = this.currentUser ? this.currentUser.role : null;
                let visible = modules;
                if (role === 'customer') {
                    visible = modules.filter(m => m.id === 'shop');
                } else if (role === 'staff') {
                    visible = modules.filter(m => ['orders','shop'].includes(m.id));
                } else if (role === 'manager') {
                    visible = modules.filter(m => ['customers','stock','orders','production','operation','packaging','logistic','reports','shop'].includes(m.id));
                }

                visible = visible.filter(module => this.hasModuleAccess(module.id));

                const grid = document.getElementById('modulesGrid');
                if (!visible.length) {
                    grid.innerHTML = '<p style="color:#94a3b8;">No modules assigned to this user. Please contact an administrator.</p>';
                } else {
                    grid.innerHTML = visible.map(module => `
                        <div class="module-card" onclick="app.selectModule('${module.id}')">
                            <div class="module-icon">${module.icon}</div>
                            <div class="module-name">${module.name}</div>
                            <div class="module-desc">${module.desc}</div>
                        </div>
                    `).join('');
                }
            }

            selectModule(moduleId) {
                const moduleNames = {
                    'stock': 'Stock Management',
                    'orders': 'Orders',
                    'production': 'Production',
                    'operation': 'Operation',
                    'packaging': 'Packaging',
                    'logistic': 'Logistic',
                    'settings': 'Settings',
                    'menu': 'Menu',
                    'website': 'Website',
                    'shop': 'Shop'
                };

                if (!this.hasModuleAccess(moduleId)) {
                    this.showNotification('Access denied for this module', 'error');
                    return;
                }
                
                this.showNotification(`Opened: ${moduleNames[moduleId]}`, 'success');
                this.logActivity(`Accessed module: ${moduleNames[moduleId]}`);
                // Ensure dashboard/main layout is visible, then show the requested page
                this.showDashboard();
                this.showPage(moduleId);
                // render-specific hooks
                if (moduleId === 'stock') this.renderStock();
                if (moduleId === 'shop') this.renderShop();
            }

                if (isCSV) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            // Always decode as UTF-8 for Arabic compatibility
                            const text = new TextDecoder('utf-8').decode(new Uint8Array([...e.target.result].map(c => c.charCodeAt ? c.charCodeAt(0) : c)));
                            const wb = XLSX.read(text, { type: 'string' });
                            parseWorkbook(wb, file.name);
                        } catch (err) {
                            console.error(err);
                            this.showNotification('Failed to parse CSV file', 'error');
                        }
                    };
                    reader.readAsText(file, 'utf-8');
                this.showTopNav(false);
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }

            showDashboard() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('modulesPage').classList.remove('active');
                document.getElementById('dashboard').classList.add('active');
                this.showTopNav(true);
                this.updateUI();
            }

            hideDashboard() {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('modulesPage').classList.remove('active');
                this.showTopNav(false);
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                this.applyRememberedLoginUI();
            }

            updateUI() {
                if (!this.currentUser) return;

                document.getElementById('sidebarUserName').textContent = this.currentUser.username;
                document.getElementById('sidebarUserRole').textContent = 'Role: ' + this.currentUser.role.toUpperCase();

                // Show/hide sections based on role
                const adminSection = document.getElementById('adminSection');
                const managerSection = document.getElementById('managerSection');
                const staffSection = document.getElementById('staffSection');

                adminSection.style.display = this.currentUser.role === 'admin' ? 'block' : 'none';
                managerSection.style.display = this.currentUser.role === 'manager' ? 'block' : 'none';
                staffSection.style.display = this.currentUser.role === 'staff' ? 'block' : 'none';

                this.applyNavPermissionVisibility();
                this.updateStats();
                const defaultPage = this.hasModuleAccess('dashboard') ? 'dashboard' : this.getFirstAllowedPageName();
                if (defaultPage) {
                    this.showPage(defaultPage);
                } else {
                    this.showNotification('No accessible pages have been assigned to your user.', 'error');
                }
            }

            showPage(pageName, evt = null) {
                if (this.currentUser) {
                    const moduleKey = this.pagePermissionMap[pageName] || pageName;
                    if (!this.hasModuleAccess(moduleKey)) {
                        this.showNotification('Access denied for this page', 'error');
                        return;
                    }
                }
                
                // Close mobile sidebar if open
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const toggle = document.getElementById('mobileMenuToggle');
                    const overlay = document.getElementById('mobileSidebarOverlay');
                    if (sidebar && sidebar.classList.contains('mobile-open')) {
                        sidebar.classList.remove('mobile-open');
                        if (toggle) toggle.classList.remove('active');
                        if (overlay) overlay.classList.remove('active');
                    }
                }
                
                // Hide all pages (remove active and clear inline display)
                document.querySelectorAll('.page').forEach(p => { p.classList.remove('active'); p.style.display = 'none'; });

                // Show selected page (make visible and mark active)
                const pageEl = document.getElementById(pageName + 'Page');
                if (pageEl) { pageEl.style.display = 'block'; pageEl.classList.add('active'); }

                // Update nav items: try to match onclick attribute to determine active item
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                const navItems = Array.from(document.querySelectorAll('.nav-item'));
                let marked = false;
                navItems.forEach(item => {
                    const onclick = item.getAttribute('onclick') || '';
                    if (onclick.includes(`'${pageName}'`) || onclick.includes(`"${pageName}"`) || onclick.includes(pageName)) {
                        item.classList.add('active');
                        marked = true;
                    }
                });
                // Fallback: if called from an event, mark its target
                if (!marked && evt && evt.target) {
                    evt.target.classList.add('active');
                }

                // Load page content
                if (pageName === 'users') this.renderUsersTable();
                if (pageName === 'customers') this.renderCustomersTable();
                if (pageName === 'categories') this.renderCategoriesTable();
                if (pageName === 'permissions') this.renderPermissions();
                if (pageName === 'products') this.renderProducts();
                if (pageName === 'orders') this.renderOrders();
                if (pageName === 'inventory') this.renderInventory();
                if (pageName === 'stock') this.renderStock();
                if (pageName === 'reports') this.renderReports();
                if (pageName === 'shop') this.renderShop();
                if (pageName === 'manufacturing') this.renderManufacturing();
                if (pageName === 'operation') this.renderOperation();
                if (pageName === 'packaging') this.renderPackaging();
                if (pageName === 'production') this.renderProduction();
            }

            updateStats() {
                document.getElementById('statUsers').textContent = this.users.length;
                document.getElementById('statOrders').textContent = this.orders.length;
                document.getElementById('statProducts').textContent = this.products.length;
                const revenue = this.orders.reduce((sum, o) => {
                    const product = this.products.find(p => p.name === o.product);
                    return sum + (product ? product.price * o.qty : 0);
                }, 0);
                document.getElementById('statRevenue').textContent = '$' + revenue.toFixed(0);
            }

            /* ===== REPORTS ===== */
            renderReports() {
                const container = document.getElementById('reportsContent');
                if (!container) return;
                const q = (document.getElementById('reportSearch')?.value || '').toLowerCase();

                // Stock levels
                const stockRows = this.stockItems.filter(i => !q || (i.name||'').toLowerCase().includes(q) || (i.code||'').toLowerCase().includes(q) || (i.group||'').toLowerCase().includes(q)).map(i => `
                    <tr>
                        <td>${i.code}</td>
                        <td>${i.name}</td>
                        <td>${i.group}</td>
                        <td>${i.unit}</td>
                        <td>${i.qty}</td>
                        <td>${i.reorder || ''}</td>
                    </tr>
                `).join('');

                // Recent transactions
                const txRows = this.stockTransactions.slice().reverse().filter(t => {
                    if (!q) return true;
                    const item = this.stockItems.find(i=>i.id===t.itemId) || {};
                    return (item.name||'').toLowerCase().includes(q) || (t.note||'').toLowerCase().includes(q);
                }).map(t => {
                    const item = this.stockItems.find(i=>i.id===t.itemId) || { name: 'Deleted' };
                    return `<tr><td>${t.id}</td><td>${item.name}</td><td>${t.type}</td><td>${t.qty}</td><td>${t.date.split('T')[0]}</td><td>${t.note||''}</td></tr>`;
                }).join('');

                // Orders with line items
                const orderRows = this.orders.filter(o => !q || (o.customer||'').toLowerCase().includes(q) || (o.lineItems || []).some(li => {
                    const item = this.stockItems.find(i => i.id === li.itemId);
                    return (item ? item.name : '').toLowerCase().includes(q);
                }) || (o.product||'').toLowerCase().includes(q)).map(o => {
                    let items = '';
                    if (o.lineItems && o.lineItems.length > 0) {
                        items = o.lineItems.map(li => {
                            const item = this.stockItems.find(i=>i.id===li.itemId) || { name: 'Deleted' };
                            return `${li.qty}x ${item.name}`;
                        }).join(', ');
                    } else if (o.product && o.qty) {
                        items = `${o.qty}x ${o.product}`;
                    }
                    return `<tr><td>#${o.id}</td><td>${o.customer}</td><td>${items}</td><td>${o.date}</td><td>${o.status}</td></tr>`;
                }).join('');

                // Operations log
                const operationRows = this.operations.filter(op => {
                    if (!q) return true;
                    const item = this.stockItems.find(i => i.id === op.itemId);
                    return [op.cart, op.notes, op.time, item ? item.name : '']
                        .some(val => (val || '').toLowerCase().includes(q));
                }).map(op => {
                    const item = this.stockItems.find(i => i.id === op.itemId) || { name: 'Deleted' };
                    return `<tr><td>${op.id}</td><td>${op.cart || '-'}</td><td>${op.time || '-'}</td><td>${item.name}</td><td>${op.quantity || 0}</td><td>${op.scrap || 0}</td><td>${op.notes || ''}</td></tr>`;
                }).join('');

                // Packaging log
                const packagingRows = this.packaging.filter(pkg => {
                    if (!q) return true;
                    const item = this.stockItems.find(i => i.id === pkg.itemId);
                    return [pkg.cart, pkg.notes, pkg.time, item ? item.name : '']
                        .some(val => (val || '').toLowerCase().includes(q));
                }).map(pkg => {
                    const item = this.stockItems.find(i => i.id === pkg.itemId) || { name: 'Deleted' };
                    return `<tr><td>${pkg.id}</td><td>${pkg.cart || '-'}</td><td>${pkg.time || '-'}</td><td>${item.name}</td><td>${pkg.quantity || 0}</td><td>${pkg.scrap || 0}</td><td>${pkg.notes || ''}</td></tr>`;
                }).join('');

                container.innerHTML = `
                    <h3>Stock Levels</h3>
                    <table class="table"><thead><tr><th>Code</th><th>Name</th><th>Group</th><th>Unit</th><th>Qty</th><th>Reorder</th></tr></thead><tbody>${stockRows || '<tr><td colspan="6">No items</td></tr>'}</tbody></table>

                    <h3 style="margin-top:20px">Recent Stock Transactions</h3>
                    <table class="table"><thead><tr><th>ID</th><th>Item</th><th>Type</th><th>Qty</th><th>Date</th><th>Note</th></tr></thead><tbody>${txRows || '<tr><td colspan="6">No transactions</td></tr>'}</tbody></table>

                    <h3 style="margin-top:20px">Orders</h3>
                    <table class="table"><thead><tr><th>Order</th><th>Customer</th><th>Items</th><th>Date</th><th>Status</th></tr></thead><tbody>${orderRows || '<tr><td colspan="5">No orders</td></tr>'}</tbody></table>

                    <h3 style="margin-top:20px">Operations</h3>
                    <table class="table"><thead><tr><th>ID</th><th>Cart</th><th>Time</th><th>Item</th><th>Qty</th><th>Scrap</th><th>Notes</th></tr></thead><tbody>${operationRows || '<tr><td colspan="7">No operations</td></tr>'}</tbody></table>

                    <h3 style="margin-top:20px">Packaging</h3>
                    <table class="table"><thead><tr><th>ID</th><th>Cart</th><th>Time</th><th>Item</th><th>Qty</th><th>Scrap</th><th>Notes</th></tr></thead><tbody>${packagingRows || '<tr><td colspan="7">No packaging records</td></tr>'}</tbody></table>
                `;
            }

            renderUsersTable() {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = this.users.map(user => `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><span class="status-badge role-${user.role}">${user.role.toUpperCase()}</span></td>
                        <td><span class="status-badge status-${user.status}">${user.status.toUpperCase()}</span></td>
                        <td>${user.created}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn-small btn-edit" onclick="app.editUser(${user.id})">Edit</button>
                                <button class="btn-small btn-delete" onclick="app.deleteUser(${user.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            /* ===== CUSTOMERS ===== */
            renderCustomersTable() {
                const tbody = document.getElementById('customersTableBody');
                if (!tbody) return;

                tbody.innerHTML = this.customers.map(c => `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.email || ''}</td>
                        <td>${c.phone || ''}</td>
                        <td>${(c.allowedProducts || []).length}</td>
                        <td>${c.created}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn-small btn-edit" onclick="app.editCustomer(${c.id})">Edit</button>
                                <button class="btn-small btn-delete" onclick="app.deleteCustomer(${c.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            showCustomerModal(customerId = null) {
                const modal = document.getElementById('customerModal');
                modal.classList.add('active');
                modal.dataset.customerId = customerId || '';
                const selContainer = document.getElementById('customerAllowedProducts');
                selContainer.innerHTML = (this.stockItems || []).map(i => `
                    <div class="permission-item">
                        <input type="checkbox" id="custprod_${i.id}" value="${i.id}">
                        <label for="custprod_${i.id}">${i.code} ‚Äî ${i.name}</label>
                    </div>
                `).join('');

                if (customerId) {
                    const c = this.customers.find(x => x.id === customerId);
                    document.getElementById('modalCustomerName').value = c.name;
                    document.getElementById('modalCustomerEmail').value = c.email || '';
                    document.getElementById('modalCustomerPhone').value = c.phone || '';
                    (c.allowedProducts || []).forEach(pid => {
                        const cb = document.getElementById('custprod_' + pid);
                        if (cb) cb.checked = true;
                    });
                    document.getElementById('customerModalTitle').textContent = 'Edit Customer';
                } else {
                    document.getElementById('modalCustomerName').value = '';
                    document.getElementById('modalCustomerEmail').value = '';
                    document.getElementById('modalCustomerPhone').value = '';
                    document.getElementById('customerModalTitle').textContent = 'Create Customer';
                }
            }

            closeCustomerModal() { document.getElementById('customerModal').classList.remove('active'); }

            saveCustomer() {
                const id = document.getElementById('customerModal').dataset.customerId;
                const name = document.getElementById('modalCustomerName').value.trim();
                const email = document.getElementById('modalCustomerEmail').value.trim();
                const phone = document.getElementById('modalCustomerPhone').value.trim();
                if (!name) { this.showNotification('Customer name required', 'error'); return; }

                const allowed = Array.from(document.querySelectorAll('#customerAllowedProducts input[type="checkbox"]')).filter(cb => cb.checked).map(cb => parseInt(cb.value));

                if (id) {
                    const c = this.customers.find(x => x.id === parseInt(id));
                    c.name = name; c.email = email; c.phone = phone; c.allowedProducts = allowed;
                    this.showNotification('Customer updated', 'success');
                } else {
                    const newId = this.customers.length ? Math.max(...this.customers.map(c => c.id))+1 : 1;
                    this.customers.push({ id: newId, name, email, phone, allowedProducts: allowed, created: new Date().toISOString().split('T')[0] });
                    this.showNotification('Customer created', 'success');
                }

                this.saveToStorage();
                this.closeCustomerModal();
                this.renderCustomersTable();
            }

            editCustomer(customerId) { this.showCustomerModal(customerId); }

            deleteCustomer(customerId) {
                if (!confirm('Delete customer?')) return;
                this.customers = this.customers.filter(c => c.id !== customerId);
                this.saveToStorage();
                this.showNotification('Customer deleted', 'success');
                this.renderCustomersTable();
            }

            /* ===== CATEGORIES ===== */
            renderCategoriesTable() {
                const tbody = document.getElementById('categoriesTableBody');
                if (!tbody) return;
                tbody.innerHTML = this.categories.map(cat => `
                    <tr>
                        <td><strong>${cat.name}</strong></td>
                        <td>${cat.description || ''}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn-small btn-edit" onclick="app.showCategoryModal(${cat.id})">Edit</button>
                                <button class="btn-small btn-delete" onclick="app.deleteCategory(${cat.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            showCategoryModal(catId = null) {
                const modal = document.getElementById('categoryModal');
                modal.classList.add('active');
                modal.dataset.catId = catId || '';
                if (catId) {
                    const cat = this.categories.find(c => c.id === catId);
                    document.getElementById('modalCategoryName').value = cat.name;
                    document.getElementById('modalCategoryDesc').value = cat.description || '';
                    document.getElementById('categoryModalTitle').textContent = 'Edit Category';
                } else {
                    document.getElementById('modalCategoryName').value = '';
                    document.getElementById('modalCategoryDesc').value = '';
                    document.getElementById('categoryModalTitle').textContent = 'Create Category';
                }
            }

            closeCategoryModal() {
                document.getElementById('categoryModal').classList.remove('active');
            }

            saveCategory() {
                const catId = document.getElementById('categoryModal').dataset.catId;
                const name = document.getElementById('modalCategoryName').value.trim();
                const description = document.getElementById('modalCategoryDesc').value.trim();
                if (!name) { this.showNotification('Category name required', 'error'); return; }
                if (catId) {
                    const cat = this.categories.find(c => c.id === parseInt(catId));
                    cat.name = name; cat.description = description;
                    this.showNotification('Category updated', 'success');
                } else {
                    const newId = this.categories.length ? Math.max(...this.categories.map(c => c.id))+1 : 1;
                    this.categories.push({ id: newId, name, description });
                    this.showNotification('Category created', 'success');
                }
                this.saveToStorage();
                this.closeCategoryModal();
                this.renderCategoriesTable();
            }

            deleteCategory(catId) {
                if (!confirm('Delete this category?')) return;
                this.categories = this.categories.filter(c => c.id !== catId);
                this.saveToStorage();
                this.showNotification('Category deleted', 'success');
                this.renderCategoriesTable();
            }

            renderPermissions() {
                const content = document.getElementById('permissionsContent');
                if (!content) return;
                if (!this.users.length) {
                    content.innerHTML = '<p style="color:#94a3b8;">Create a user to begin configuring permissions.</p>';
                    return;
                }

                if (!this.activePermissionUserId || !this.users.some(u => u.id === this.activePermissionUserId)) {
                    this.activePermissionUserId = this.users[0].id;
                }

                const user = this.users.find(u => u.id === this.activePermissionUserId);
                this.ensureUserPermissionDefaultsForUser(user);

                const userOptions = this.users
                    .map(u => `<option value="${u.id}" ${u.id === user.id ? 'selected' : ''}>${u.username} (${u.role})</option>`)
                    .join('');

                let html = `
                    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;margin-bottom:20px;">
                        <div style="min-width:220px;">
                            <label style="font-weight:600;display:block;margin-bottom:4px;">Select user</label>
                            <select id="permissionUserSelect" onchange="app.selectPermissionUser(this.value)" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;">
                                ${userOptions}
                            </select>
                        </div>
                        <div style="flex:1;min-width:220px;font-size:13px;color:#475569;">
                            <div><strong>Role:</strong> ${user.role.toUpperCase()}</div>
                            <div><strong>Last update:</strong> ${user.permissionsUpdatedAt ? new Date(user.permissionsUpdatedAt).toLocaleString() : '‚Äî'}</div>
                        </div>
                    </div>
                `;

                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;">';
                Object.entries(this.permissionCatalog).forEach(([moduleKey, moduleDef]) => {
                    const moduleEnabled = !!user.modulePermissions[moduleKey];
                    const features = moduleDef.features || [];
                    html += `
                        <div style="border:1px solid #e2e8f0;border-radius:14px;padding:14px;background:#fff;box-shadow:0 4px 12px rgba(15,23,42,0.08);">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                                <label style="font-weight:600;display:flex;align-items:center;gap:8px;">
                                    <input type="checkbox" ${moduleEnabled ? 'checked' : ''} onchange="app.toggleUserModulePermission(${user.id}, '${moduleKey}', this.checked)">
                                    <span>${moduleDef.icon ? moduleDef.icon + ' ' : ''}${moduleDef.label}</span>
                                </label>
                            </div>
                            ${moduleDef.description ? `<p style="margin:8px 0 0;font-size:12px;color:#64748b;">${moduleDef.description}</p>` : ''}
                    `;

                    if (features.length) {
                        const featureMap = user.featurePermissions[moduleKey] || {};
                        html += `<div style="margin-top:12px;padding-top:10px;border-top:1px dashed #e2e8f0;${moduleEnabled ? '' : 'opacity:0.45;'}">`;
                        features.forEach(feature => {
                            const allowed = moduleEnabled && !!featureMap[feature.key];
                            html += `
                                <label style="display:flex;align-items:center;gap:6px;font-size:13px;margin-bottom:6px;">
                                    <input type="checkbox" ${allowed ? 'checked' : ''} ${moduleEnabled ? '' : 'disabled'} onchange="app.toggleUserFeaturePermission(${user.id}, '${moduleKey}', '${feature.key}', this.checked)">
                                    <span>${feature.label}</span>
                                </label>
                            `;
                        });
                        html += '</div>';
                    }

                    html += '</div>';
                });

                html += '</div>';
                content.innerHTML = html;
            }

            renderProducts() {
                const content = document.getElementById('productsContent');
                if (this.products.length === 0) {
                    content.innerHTML = '<p>No products yet</p>';
                    return;
                }

                content.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Price</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.products.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>$${p.price}</td>
                                    <td>${p.stock} units</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            /* ===== SHOP PAGE (for customers) ===== */
            renderShop() {
                const container = document.getElementById('shopContent');
                if (!container) return;

                const productsHtml = (this.stockItems || []).map(i => `
                    <div class="shop-item">
                        <div><strong>${i.name}</strong> <small style="color:#666">(${i.code})</small></div>
                        <div style="margin-top:6px;color:#333">${i.qty} ${i.unit} available</div>
                        <div style="margin-top:8px;display:flex;gap:8px">
                            <input type="number" id="shop_qty_${i.id}" value="1" min="1" style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px">
                            <button class="btn btn-primary" onclick="app.addToCart(${i.id})">Add to cart</button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div style="display:flex;gap:16px;align-items:flex-start;">
                        <div style="flex:2">
                            <h3>Products</h3>
                            <div>${productsHtml || '<p>No products available</p>'}</div>
                        </div>
                        <div style="flex:1">
                            <h3>Cart</h3>
                            <div id="shopCartContainer">(cart is empty)</div>
                            <button class="btn btn-primary" id="checkoutBtn" onclick="app.checkoutCart()" style="margin-top:10px;display:none">Checkout</button>
                        </div>
                    </div>
                `;
                this.cart = this.cart || [];
                this.renderCart();
            }

            addToCart(itemId) {
                const qtyEl = document.getElementById('shop_qty_' + itemId);
                const qty = parseFloat(qtyEl?.value) || 1;
                const item = this.stockItems.find(i => i.id === itemId);
                if (!item) return this.showNotification('Item not found', 'error');
                if (item.qty < qty) {
                    if (!confirm('Quantity exceeds available stock. Add anyway?')) return;
                }
                this.cart = this.cart || [];
                const existing = this.cart.find(c => c.itemId === itemId);
                if (existing) existing.qty += qty; else this.cart.push({ itemId, qty });
                this.showNotification('Added to cart', 'success');
                this.renderCart();
            }

            renderCart() {
                const container = document.getElementById('shopCartContainer');
                if (!container) return;
                if (!this.cart || this.cart.length === 0) {
                    container.innerHTML = '(cart is empty)';
                    document.getElementById('checkoutBtn').style.display = 'none';
                    return;
                }
                const rows = this.cart.map((c, idx) => {
                    const item = this.stockItems.find(i => i.id === c.itemId) || { name: 'Deleted' };
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0"><div>${c.qty} x ${item.name}</div><div><button class="btn-small btn-delete" onclick="app.removeFromCart(${idx})">Remove</button></div></div>`;
                }).join('');
                container.innerHTML = rows;
                document.getElementById('checkoutBtn').style.display = 'block';
            }

            removeFromCart(idx) {
                if (!this.cart) return;
                this.cart.splice(idx,1);
                this.renderCart();
            }

            checkoutCart() {
                if (!this.currentUser || this.currentUser.role !== 'customer') return this.showNotification('Only customers can checkout here', 'error');
                if (!this.cart || this.cart.length === 0) return this.showNotification('Cart is empty', 'error');
                // create order as pending
                const validated = [];
                for (let c of this.cart) {
                    const item = this.stockItems.find(i => i.id === c.itemId);
                    if (!item) return this.showNotification('Item not found', 'error');
                    validated.push({ itemId: item.id, qty: c.qty, notes: '' });
                }
                const newId = this.orders.length ? Math.max(...this.orders.map(o=>o.id))+1 : 1;
                const order = { id: newId, customer: this.currentUser.username, lineItems: validated, date: new Date().toISOString().split('T')[0], status: 'pending', notes: 'Placed from shop' };
                this.orders.push(order);
                this.saveToStorage();
                this.cart = [];
                this.renderCart();
                this.showNotification('Order placed (pending approval)', 'success');
                this.logActivity(`Customer ${this.currentUser.username} placed order #${order.id}`);
                // If current user is customer, optionally redirect to orders page
                this.showPage('orders');
            }

            renderOrders() {
                const content = document.getElementById('ordersContent');
                const html = `
                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="app.showOrderModal()">‚ûï Create Order</button>
                        <button class="btn btn-secondary" onclick="app.exportOrders()">Export Orders (CSV)</button>
                        <div style="flex:1"></div>
                        <input id="orderSearch" placeholder="Search orders by customer, product" style="padding:8px;border:1px solid #ddd;border-radius:8px;width:260px" oninput="app.applyOrderFilter()">
                    </div>

                    <div class="content-card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Count</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody"></tbody>
                        </table>
                    </div>
                `;

                content.innerHTML = html;
                this.renderOrdersTable();
            }

            // Show shop page for customers
            showShopPage() {
                this.showDashboard();
                this.showPage('shop');
                this.renderShop();
            }

            renderOrdersTable() {
                const tbody = document.getElementById('ordersTableBody');
                if (!tbody) return;

                const q = (document.getElementById('orderSearch')?.value || '').toLowerCase();
                const rows = this.orders.filter(o => {
                    if (!q) return true;
                    // Handle both old and new order formats
                    const itemNames = (o.lineItems || []).map(li => {
                        const item = this.stockItems.find(i => i.id === li.itemId);
                        return (item ? item.name : '').toLowerCase();
                    }).join(' ');
                    return (o.customer||'').toLowerCase().includes(q) || itemNames.includes(q) || (String(o.id)||'').includes(q);
                }).map(o => {
                    // Handle both old and new order formats for display
                    let itemCount, items;
                    if (o.lineItems && o.lineItems.length > 0) {
                        itemCount = o.lineItems.length;
                        items = o.lineItems.map(li => {
                            const item = this.stockItems.find(i => i.id === li.itemId);
                            return `${li.qty}x ${item ? item.name : 'Deleted'}`;
                        }).join(', ');
                    } else if (o.product && o.qty) {
                        // Old format fallback
                        itemCount = 1;
                        items = `${o.qty}x ${o.product}`;
                    } else {
                        itemCount = 0;
                        items = 'No items';
                    }
                    const idDisplay = o.status === 'pending' ? `<span class="pending-dot" title="Pending"></span> #${o.id}` : `#${o.id}`;
                    return `
                    <tr onclick="app.viewOrder(${o.id})" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background=''">
                        <td>${idDisplay}</td>
                        <td>${o.customer}</td>
                        <td>${items}</td>
                        <td>${itemCount} item(s)</td>
                        <td>${o.date}</td>
                        <td><span class="status-badge status-${o.status}">${o.status.toUpperCase()}</span></td>
                    </tr>
                `;}).join('');

                tbody.innerHTML = rows || '<tr><td colspan="6">No orders found</td></tr>';
            }

            // Approve / Reject orders
            approveOrder(orderId) {
                const o = this.orders.find(x => x.id === orderId);
                if (!o) return this.showNotification('Order not found', 'error');
                if (o.status !== 'pending') return this.showNotification('Only pending orders can be approved', 'warning');

                // Check customer permissions
                const customer = this.customers.find(c => c.name === o.customer || c.id === o.customer || c.id === o.customerId);
                const disallowed = (o.lineItems || []).filter(li => customer && customer.allowedProducts && customer.allowedProducts.length && !customer.allowedProducts.includes(li.itemId));
                if (disallowed.length) {
                    if (!confirm('Order contains items not allowed for this customer. Approve anyway?')) return;
                }

                // Reduce stock and add transactions
                (o.lineItems || []).forEach(li => {
                    const item = this.stockItems.find(i => i.id === li.itemId);
                    if (item) {
                        item.qty = item.qty - li.qty;
                        const txId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t=>t.id))+1 : 1;
                        this.stockTransactions.push({ id: txId, itemId: item.id, type: 'sale', qty: li.qty, date: new Date().toISOString(), note: `Approved order #${o.id}` });
                    }
                });
                o.status = 'confirmed';
                this.saveToStorage();
                this.renderStockTable();
                this.renderStockTransactions();
                this.renderOrdersTable();
                this.showNotification('Order approved and stock updated', 'success');
                this.logActivity(`Order #${o.id} approved`);
                document.getElementById('orderDetailModal').classList.remove('active');
            }

            rejectOrder(orderId) {
                const o = this.orders.find(x => x.id === orderId);
                if (!o) return this.showNotification('Order not found', 'error');
                if (o.status !== 'pending') return this.showNotification('Only pending orders can be rejected', 'warning');
                o.status = 'rejected';
                this.saveToStorage();
                this.renderOrdersTable();
                this.showNotification('Order rejected', 'info');
                this.logActivity(`Order #${o.id} rejected`);
                document.getElementById('orderDetailModal').classList.remove('active');
            }

            renderInventory() {
                const content = document.getElementById('inventoryContent');
                if (this.products.length === 0) {
                    content.innerHTML = '<p>No inventory items yet</p>';
                    return;
                }

                content.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Stock Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.products.map(p => {
                                const status = p.stock < 30 ? 'low' : 'ok';
                                return `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.stock} units</td>
                                        <td><span class="status-badge status-${status}">${status.toUpperCase()}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            /* ===== STOCK MODULE ===== */
            renderStock() {
                const container = document.getElementById('stockContent');
                if (!container) return;

                const html = `
                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="app.openStockEditor()">‚ûï Create Item</button>
                        <button class="btn btn-secondary" onclick="app.exportStockItems()">Export Items (CSV)</button>
                        <button class="btn btn-secondary" onclick="app.exportStockTransactions()">Export Transactions (CSV)</button>
                        <div style="flex:1"></div>
                        <input id="stockSearch" placeholder="Search by name, code, group" style="padding:8px;border:1px solid #ddd;border-radius:8px;width:260px" oninput="app.applyStockFilter()">
                    </div>

                    <div class="content-card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Group</th>
                                    <th>Unit</th>
                                    <th>Quantity</th>
                                    <th>Reorder</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stockTableBody"></tbody>
                        </table>
                    </div>

                    <div class="content-card">
                        <h3>Transactions</h3>
                        <div id="stockTransactionsContainer"></div>
                    </div>
                `;

                container.innerHTML = html;
                // Ensure the stock page container is visible within the dashboard layout
                const page = document.getElementById('stockPage');
                if (page) {
                    page.classList.add('active');
                    page.style.display = 'block';
                }
                this.showTopNav(true);
                console.log('renderStock executed');
                this.renderStockTable();
                this.renderStockTransactions();
            }

            renderStockTable(filterText='') {
                const tbody = document.getElementById('stockTableBody');
                if (!tbody) return;

                const q = (filterText || document.getElementById('stockSearch')?.value || '').toLowerCase();
                const rows = this.stockItems
                    .filter(i => {
                        if (!q) return true;
                        return (i.name || '').toLowerCase().includes(q) || (i.code||'').toLowerCase().includes(q) || (i.group||'').toLowerCase().includes(q);
                    })
                    .map(i => `
                        <tr>
                            <td>${i.code}</td>
                            <td>${i.name}</td>
                            <td>${i.group}</td>
                            <td>${i.unit}</td>
                            <td>${i.qty}</td>
                            <td>${i.reorder || ''}</td>
                            <td>
                                ${[''+(i.canBeSold ? '<span class="tag tag-sell">Can Be Sold</span>' : ''),
                                   ''+(i.isSemiProduct ? '<span class="tag tag-semi">Semi Product</span>' : ''),
                                   ''+(i.isPack ? '<span class="tag tag-pack">Pack</span>' : '')]
                                   .filter(Boolean).join('') || '-'}
                                ${i.isPack && i.packItemId ? `<div style="font-size:11px;color:#555;margin-top:4px;">Contains ${i.packQuantity || 0} √ó ${(this.stockItems.find(si => si.id === i.packItemId)?.name) || 'Item'}</div>` : ''}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn-small btn-edit" onclick="app.editStockItem(${i.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="app.deleteStockItem(${i.id})">Delete</button>
                                    <button class="btn-small btn-edit" onclick="app.adjustStock(${i.id}, 'in')">+In</button>
                                    <button class="btn-small btn-edit" onclick="app.adjustStock(${i.id}, 'out')">-Out</button>
                                    <button class="btn-small btn-edit" onclick="app.showTransferModal(${i.id})">Transfer</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');

                tbody.innerHTML = rows || '<tr><td colspan="7">No items found</td></tr>';
            }

            handleStockImport(evt) {
                const file = evt?.target?.files?.[0];
                if (!file) return this.showNotification('No file selected', 'error');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        const wsName = wb.SheetNames[0];
                        const ws = wb.Sheets[wsName];
                        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

                        let added = 0;
                        rows.forEach(r => {
                            // normalize keys to lowercase
                            const norm = {};
                            Object.keys(r).forEach(k => { norm[k.toLowerCase().trim()] = r[k]; });

                            const code = (norm['code'] || norm['item code'] || '').toString().trim();
                            const name = (norm['name'] || norm['item'] || '').toString().trim();
                            const group = (norm['group'] || '').toString().trim();
                            const unit = (norm['unit'] || '').toString().trim();
                            const qty = parseFloat(norm['qty'] || norm['quantity'] || 0) || 0;
                            const reorder = norm['reorder'] || '';

                            if (!name && !code) return; // skip blank rows

                            // if item with same code exists, update qty and fields
                            let existing = null;
                            if (code) existing = this.stockItems.find(i => i.code && i.code.toString() === code.toString());
                            if (existing) {
                                existing.name = name || existing.name;
                                existing.group = group || existing.group;
                                existing.unit = unit || existing.unit;
                                existing.reorder = reorder || existing.reorder;
                                existing.qty = (existing.qty || 0) + qty;
                            } else {
                                const newId = this.stockItems.length ? Math.max(...this.stockItems.map(i => i.id)) + 1 : 1;
                                const normalizedUnit = (unit || 'pcs');
                                this.stockItems.push({ id: newId, code: code || '', name: name || 'Unnamed', group: group || '', unit: normalizedUnit, qty: qty, reorder: reorder || '', created: new Date().toISOString().split('T')[0], canBeSold: false, isSemiProduct: false, isPack: false, packItemId: null, packQuantity: null });
                            }
                            if (qty) {
                                const txId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t => t.id)) + 1 : 1;
                                const item = this.stockItems.find(i => (code && i.code && i.code.toString() === code.toString()) || (!code && i.name === name));
                                if (item) this.stockTransactions.push({ id: txId, itemId: item.id, type: 'import', qty: qty, date: new Date().toISOString(), note: `Import from file ${file.name}` });
                            }
                            added++;
                        });

                        this.saveToStorage();
                        this.renderStockTable();
                        this.renderStockTransactions();
                        this.showNotification(`${added} rows imported`, 'success');
                    } catch (err) {
                        console.error(err);
                        this.showNotification('Failed to parse file', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            openStockEditor(itemId = null) {
                this.editingStockId = itemId ? parseInt(itemId) : null;
                this.showPage('stockEditor');

                const titleEl = document.getElementById('stockEditorTitle');
                const subtitleEl = document.getElementById('stockEditorSubtitle');
                const metaEl = document.getElementById('stockEditorMeta');
                const bomList = document.getElementById('bomList');
                const flagSell = document.getElementById('stockFlagSell');
                const flagSemi = document.getElementById('stockFlagSemi');
                const flagPack = document.getElementById('stockFlagPack');
                const packDetails = document.getElementById('packDetails');
                const packItemSelect = document.getElementById('packItemSelect');
                const packItemQuantity = document.getElementById('packItemQuantity');

                const groupSelect = document.getElementById('modalStockGroup');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">-- Select Category --</option>';
                    this.categories.forEach(cat => {
                        groupSelect.innerHTML += '<option value="' + cat.name + '">' + cat.name + ' - ' + cat.description + '</option>';
                    });
                }

                const resetFields = () => {
                    document.getElementById('modalStockCode').value = '';
                    document.getElementById('modalStockName').value = '';
                    document.getElementById('modalStockGroup').value = '';
                    document.getElementById('modalStockUnit').value = 'pcs';
                    document.getElementById('modalStockQty').value = 0;
                    document.getElementById('modalStockReorder').value = '';
                    if (flagSell) flagSell.checked = false;
                    if (flagSemi) flagSemi.checked = false;
                    if (flagPack) flagPack.checked = false;
                    if (packDetails) packDetails.style.display = 'none';
                    if (packItemSelect) packItemSelect.value = '';
                    if (packItemQuantity) packItemQuantity.value = 1;
                    if (bomList) bomList.innerHTML = '';
                };

                const populatePackSelect = () => {
                    if (!packItemSelect) return;
                    const currentId = this.editingStockId;
                    packItemSelect.innerHTML = '<option value="">-- Select Item --</option>';
                    (this.stockItems || []).forEach(item => {
                        if (currentId && item.id === currentId) return;
                        packItemSelect.innerHTML += '<option value="' + item.id + '">' + (item.code || '') + ' ‚Äî ' + item.name + '</option>';
                    });
                };
                populatePackSelect();

                if (this.editingStockId) {
                    const it = this.stockItems.find(s => s.id === this.editingStockId);
                    if (!it) {
                        this.showNotification('Item not found', 'error');
                        this.cancelStockEdit();
                        return;
                    }
                    titleEl.textContent = 'Edit Item';
                    subtitleEl.textContent = 'Update inventory item and its BOM';
                    if (metaEl) metaEl.textContent = 'Created ' + (it.created || '');
                    document.getElementById('modalStockCode').value = it.code || '';
                    document.getElementById('modalStockName').value = it.name || '';
                    document.getElementById('modalStockGroup').value = it.group || '';
                    document.getElementById('modalStockUnit').value = (it.unit || 'pcs');
                    document.getElementById('modalStockQty').value = it.qty || 0;
                    document.getElementById('modalStockReorder').value = it.reorder || '';
                    if (flagSell) flagSell.checked = !!it.canBeSold;
                    if (flagSemi) flagSemi.checked = !!it.isSemiProduct;
                    if (flagPack) flagPack.checked = !!it.isPack;
                    if (packDetails) packDetails.style.display = it.isPack ? 'block' : 'none';
                    if (packItemSelect) packItemSelect.value = it.packItemId || '';
                    if (packItemQuantity) packItemQuantity.value = it.packQuantity || 1;
                    if (bomList) {
                        bomList.innerHTML = '';
                        const bom = (it.bom && Array.isArray(it.bom)) ? it.bom : [];
                        if (bom.length) {
                            bom.forEach(item => this.addBomRow(item.itemId, item.qty));
                        } else {
                            this.addBomRow();
                        }
                    }
                } else {
                    titleEl.textContent = 'Create Item';
                    subtitleEl.textContent = 'Add a new finished good or raw material';
                    if (metaEl) metaEl.textContent = '';
                    resetFields();
                    if (packDetails) packDetails.style.display = 'none';
                    this.addBomRow();
                }

                if (flagPack) {
                    flagPack.onchange = () => {
                        if (flagPack.checked) {
                            packDetails.style.display = 'block';
                            populatePackSelect();
                        } else {
                            packDetails.style.display = 'none';
                        }
                    };
                }
            }

            cancelStockEdit() {
                this.editingStockId = null;
                this.showPage('stock');
            }

            saveStockItem() {
                const id = this.editingStockId;
                const code = document.getElementById('modalStockCode').value.trim();
                const name = document.getElementById('modalStockName').value.trim();
                const group = document.getElementById('modalStockGroup').value.trim();
                const unit = document.getElementById('modalStockUnit').value || 'pcs';
                const qty = parseFloat(document.getElementById('modalStockQty').value) || 0;
                const reorder = parseFloat(document.getElementById('modalStockReorder').value) || 0;
                const canBeSold = document.getElementById('stockFlagSell').checked;
                const isSemiProduct = document.getElementById('stockFlagSemi').checked;
                const isPack = document.getElementById('stockFlagPack').checked;
                const packItemId = isPack ? parseInt(document.getElementById('packItemSelect').value) : null;
                const packQuantity = isPack ? (parseFloat(document.getElementById('packItemQuantity').value) || 0) : null;

                // Gather BOM (itemId and qty)
                const bomRows = document.querySelectorAll('#bomList .bom-row');
                const bom = [];
                bomRows.forEach((row) => {
                    const materialId = parseInt(row.querySelector('.bom-material').value);
                    const bomQty = parseFloat(row.querySelector('.bom-qty').value);
                    if (materialId && !isNaN(bomQty) && bomQty > 0) {
                        const material = this.stockItems.find(s => s.id === materialId);
                        if (material) {
                            bom.push({ itemId: materialId, name: material.name, qty: bomQty });
                        }
                    }
                });

                if (!code || !name) { this.showNotification('Code and name required', 'error'); return; }
                if (isPack && (!packItemId || packQuantity <= 0)) {
                    this.showNotification('Select a pack item and quantity', 'error');
                    return;
                }

                if (id) {
                    const it = this.stockItems.find(s => s.id === parseInt(id));
                    it.code = code; it.name = name; it.group = group; it.unit = unit; it.qty = qty; it.reorder = reorder; it.bom = bom;
                    it.canBeSold = canBeSold;
                    it.isSemiProduct = isSemiProduct;
                    it.isPack = isPack;
                    it.packItemId = isPack ? packItemId : null;
                    it.packQuantity = isPack ? packQuantity : null;
                    this.showNotification('Item updated', 'success');
                } else {
                    const newId = this.stockItems.length ? Math.max(...this.stockItems.map(i=>i.id))+1 : 1;
                    this.stockItems.push({ id: newId, code, name, group, unit: unit || 'pcs', qty, reorder, bom, created: new Date().toISOString().split('T')[0], canBeSold, isSemiProduct, isPack, packItemId: isPack ? packItemId : null, packQuantity: isPack ? packQuantity : null });
                    this.showNotification('Item created', 'success');
                }

                this.saveToStorage();
                this.renderStockTable();
                this.renderStockTransactions();
                this.renderManufacturing();
                this.cancelStockEdit();
            }

            editStockItem(itemId) { this.openStockEditor(itemId); }

            deleteStockItem(itemId) {
                if (!confirm('Delete this item?')) return;
                this.stockItems = this.stockItems.filter(i => i.id !== itemId);
                this.saveToStorage();
                this.renderStockTable();
                this.showNotification('Item deleted', 'success');
            }

            adjustStock(itemId, type) {
                const qty = parseFloat(prompt('Quantity to ' + (type==='in'?'add':'remove') + ':')) || 0;
                if (!qty) return;
                const it = this.stockItems.find(s => s.id === itemId);
                if (!it) return;
                it.qty = type === 'in' ? it.qty + qty : it.qty - qty;
                const txId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t=>t.id))+1 : 1;
                this.stockTransactions.push({ id: txId, itemId, type, qty, date: new Date().toISOString(), note: `${type==='in'?'Added':'Removed'} ${qty}` });
                this.saveToStorage();
                this.renderStockTable();
                this.renderStockTransactions();
                this.updateManufacturingPlan();
                this.showNotification('Stock adjusted', 'success');
            }

            renderStockTransactions() {
                const container = document.getElementById('stockTransactionsContainer');
                if (!container) return;
                const rows = this.stockTransactions.slice().reverse().map(t => {
                    const item = this.stockItems.find(i=>i.id===t.itemId) || { name: 'Deleted' };
                    return `<p><strong>${t.date.split('T')[0]}</strong> ‚Äî ${t.type.toUpperCase()} ${t.qty} of ${item.name} (${t.note||''})</p>`;
                }).join('');
                container.innerHTML = rows || '<p>No transactions yet</p>';
            }

            applyStockFilter() { this.renderStockTable(); }

            /* ===== TRANSFER HANDLERS ===== */
            showTransferModal(itemId = null) {
                const modal = document.getElementById('transferModal');
                modal.classList.add('active');
                // populate items select
                const sel = document.getElementById('transferItem');
                sel.innerHTML = this.stockItems.map(i => `<option value="${i.id}">${i.code} ‚Äî ${i.name} (Avail: ${i.qty} ${i.unit})</option>`).join('');
                if (itemId) sel.value = String(itemId);
                // set default date
                document.getElementById('transferDate').value = new Date().toISOString().split('T')[0];
            }

            closeTransferModal() {
                document.getElementById('transferModal').classList.remove('active');
            }

            performTransfer() {
                const customer = document.getElementById('transferCustomer').value.trim();
                const itemId = parseInt(document.getElementById('transferItem').value);
                const qty = parseFloat(document.getElementById('transferQty').value) || 0;
                const notes = document.getElementById('transferNotes').value.trim();
                const date = document.getElementById('transferDate').value || new Date().toISOString();
                const ref = document.getElementById('transferRef').value.trim();

                if (!itemId || qty <= 0) { this.showNotification('Select item and quantity', 'error'); return; }

                const item = this.stockItems.find(i => i.id === itemId);
                if (!item) { this.showNotification('Item not found', 'error'); return; }
                if (item.qty < qty) { if (!confirm('Quantity exceeds available stock. Continue?')) return; }

                // Adjust stock (transfer out)
                item.qty = item.qty - qty;

                const txId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t=>t.id))+1 : 1;
                this.stockTransactions.push({ id: txId, itemId, type: 'transfer', qty, date: date, note: notes || `Transfer ${ref||''} to ${customer||'destination'}`, meta: { customer, ref } });

                this.saveToStorage();
                this.renderStockTable();
                this.renderStockTransactions();
                this.updateManufacturingPlan();
                this.closeTransferModal();
                this.showNotification('Transfer recorded', 'success');
                this.logActivity(`Transferred ${qty} ${item.unit} of ${item.name} ${customer ? 'to '+customer : ''}`);
            }

            /* ===== ORDER HANDLERS ===== */
            showOrderModal(itemId = null) {
                const modal = document.getElementById('orderModal');
                modal.classList.add('active');
                document.getElementById('orderCustomer').value = '';
                document.getElementById('orderNotes').value = '';
                // Initialize with one empty line item
                modal.dataset.lineItems = JSON.stringify([{itemId: itemId || '', qty: 1, notes: ''}]);
                this.renderOrderLineItems();
            }

            renderOrderLineItems() {
                const container = document.getElementById('orderLineItems');
                const lineItems = JSON.parse(document.getElementById('orderModal').dataset.lineItems || '[]');
                
                container.innerHTML = lineItems.map((li, idx) => {
                    const itemOptions = this.stockItems.map(i => `<option value="${i.id}" ${li.itemId == i.id ? 'selected' : ''}>${i.code} ‚Äî ${i.name} (Avail: ${i.qty})</option>`).join('');
                    return `
                    <div style="display:flex;gap:8px;margin-bottom:10px;align-items:flex-end">
                        <div style="flex:2">
                            <label style="font-size:12px">Item</label>
                            <select id="lineItem_${idx}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
                                <option value="">-- Select Item --</option>
                                ${itemOptions}
                            </select>
                        </div>
                        <div style="flex:1">
                            <label style="font-size:12px">Qty</label>
                            <input type="number" id="lineQty_${idx}" value="${li.qty}" min="1" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
                        </div>
                        <button class="btn-small btn-delete" onclick="app.removeOrderLineItem(${idx})">Remove</button>
                    </div>
                `;}).join('');
            }

            addOrderLineItem() {
                const lineItems = JSON.parse(document.getElementById('orderModal').dataset.lineItems || '[]');
                lineItems.push({itemId: '', qty: 1, notes: ''});
                document.getElementById('orderModal').dataset.lineItems = JSON.stringify(lineItems);
                this.renderOrderLineItems();
            }

            removeOrderLineItem(idx) {
                let lineItems = JSON.parse(document.getElementById('orderModal').dataset.lineItems || '[]');
                lineItems.splice(idx, 1);
                if (lineItems.length === 0) lineItems = [{itemId: '', qty: 1, notes: ''}];
                document.getElementById('orderModal').dataset.lineItems = JSON.stringify(lineItems);
                this.renderOrderLineItems();
            }

            closeOrderModal() { document.getElementById('orderModal').classList.remove('active'); }

            performOrder() {
                const customer = document.getElementById('orderCustomer').value.trim() || 'Walk-in';
                const notes = document.getElementById('orderNotes').value.trim();
                
                // Read line items from DOM inputs (not from dataset)
                const lineItems = [];
                let idx = 0;
                while (document.getElementById(`lineItem_${idx}`) !== null) {
                    const itemId = parseInt(document.getElementById(`lineItem_${idx}`).value);
                    const qty = parseFloat(document.getElementById(`lineQty_${idx}`).value) || 0;
                    console.log(`Line ${idx}: itemId=${itemId}, qty=${qty}`);
                    if (itemId && !isNaN(itemId) && qty > 0) {
                        lineItems.push({itemId, qty, notes: ''});
                    }
                    idx++;
                }
                
                console.log('Collected line items:', lineItems);

                if (lineItems.length === 0) {
                    this.showNotification('Add at least one item with quantity > 0', 'error');
                    return;
                }

                // Validate and collect items
                const validated = [];
                for (let li of lineItems) {
                    const item = this.stockItems.find(i => i.id == li.itemId);
                    console.log(`Validating itemId ${li.itemId}:`, item);
                    if (!item) { this.showNotification('Item not found', 'error'); return; }
                    validated.push({itemId: item.id, qty: li.qty, notes: li.notes || ''});
                }

                if (validated.length === 0) { this.showNotification('Add at least one valid item', 'error'); return; }

                // Create order
                const newId = this.orders.length ? Math.max(...this.orders.map(o=>o.id))+1 : 1;
                // Create order as pending ‚Äî requires approval
                const order = { id: newId, customer, lineItems: validated, date: new Date().toISOString().split('T')[0], status: 'pending', notes };
                this.orders.push(order);

                // Do NOT reduce stock yet ‚Äî approval flow will apply stock changes
                this.saveToStorage();
                this.renderOrdersTable();
                this.closeOrderModal();
                this.showNotification('Order created (pending approval)', 'info');
                this.logActivity(`Order #${order.id} created (pending) for ${customer}`);
            }

            viewOrder(orderId) {
                const o = this.orders.find(x=>x.id===orderId);
                if (!o) return this.showNotification('Order not found', 'error');

                // Set order details in modal
                document.getElementById('orderDetailTitle').textContent = `Order #${o.id}`;
                document.getElementById('detailOrderId').textContent = `#${o.id}`;
                document.getElementById('detailCustomer').textContent = o.customer;
                document.getElementById('detailDate').textContent = o.date;
                document.getElementById('detailStatus').innerHTML = `<span class="status-badge status-${o.status}">${o.status.toUpperCase()}</span>`;
                document.getElementById('detailNotes').textContent = o.notes || '(no notes)';

                // Populate line items
                const tbody = document.getElementById('detailLineItems');
                const itemRows = [];
                if (o.lineItems && o.lineItems.length > 0) {
                    o.lineItems.forEach(li => {
                        const item = this.stockItems.find(i => i.id === li.itemId) || { name: 'Deleted Item', unit: 'pcs' };
                        itemRows.push(`<tr><td>${item.name}</td><td>${li.qty}</td><td>${item.unit}</td></tr>`);
                    });
                } else if (o.product && o.qty) {
                    // Old format fallback
                    itemRows.push(`<tr><td>${o.product}</td><td>${o.qty}</td><td>pcs</td></tr>`);
                }
                tbody.innerHTML = itemRows.join('') || '<tr><td colspan="3">No items</td></tr>';

                // Save order id on modal for approve/reject
                const modal = document.getElementById('orderDetailModal');
                modal.dataset.orderId = o.id;

                // Show/hide edit, approve & reject buttons based on status and user role
                const editBtn = document.getElementById('editOrderBtn');
                const approveBtn = document.getElementById('approveOrderBtn');
                const rejectBtn = document.getElementById('rejectOrderBtn');
                if (o.status === 'pending' && this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'manager')) {
                    editBtn.style.display = 'inline-block';
                    editBtn.onclick = () => this.startEditOrder(o.id);
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                    approveBtn.onclick = () => this.approveOrder(o.id);
                    rejectBtn.onclick = () => this.rejectOrder(o.id);
                } else {
                    editBtn.style.display = 'none';
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                    editBtn.onclick = null; approveBtn.onclick = null; rejectBtn.onclick = null;
                }
                // Show modal
                document.getElementById('orderDetailModal').classList.add('active');
            }

            startEditOrder(orderId) {
                const o = this.orders.find(x=>x.id===orderId);
                if (!o) return this.showNotification('Order not found', 'error');
                
                // Populate edit modal with order data
                document.getElementById('editOrderCustomer').value = o.customer;
                document.getElementById('editOrderNotes').value = o.notes || '';
                
                // Initialize edit line items dataset
                const editModal = document.getElementById('orderEditModal');
                editModal.dataset.orderId = o.id;
                editModal.dataset.lineItems = JSON.stringify(o.lineItems || []);
                
                this.renderEditOrderLineItems();
                document.getElementById('orderEditModal').classList.add('active');
            }

            renderEditOrderLineItems() {
                const container = document.getElementById('editOrderLineItems');
                const lineItems = JSON.parse(document.getElementById('orderEditModal').dataset.lineItems || '[]');
                
                container.innerHTML = lineItems.map((li, idx) => {
                    const itemOptions = this.stockItems.map(i => `<option value="${i.id}" ${li.itemId == i.id ? 'selected' : ''}>${i.code} ‚Äî ${i.name} (Avail: ${i.qty})</option>`).join('');
                    return `
                    <div style="display:flex;gap:8px;margin-bottom:10px;align-items:flex-end">
                        <div style="flex:2">
                            <label style="font-size:12px">Item</label>
                            <select id="editLineItem_${idx}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
                                <option value="">-- Select Item --</option>
                                ${itemOptions}
                            </select>
                        </div>
                        <div style="flex:1">
                            <label style="font-size:12px">Qty</label>
                            <input type="number" id="editLineQty_${idx}" value="${li.qty}" min="1" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
                        </div>
                        <button class="btn-small btn-delete" onclick="app.removeEditOrderLineItem(${idx})">Remove</button>
                    </div>
                `;}).join('');
            }

            addEditOrderLineItem() {
                let lineItems = JSON.parse(document.getElementById('orderEditModal').dataset.lineItems || '[]');
                lineItems.push({itemId: '', qty: 1});
                document.getElementById('orderEditModal').dataset.lineItems = JSON.stringify(lineItems);
                this.renderEditOrderLineItems();
            }

            removeEditOrderLineItem(idx) {
                let lineItems = JSON.parse(document.getElementById('orderEditModal').dataset.lineItems || '[]');
                lineItems.splice(idx,1);
                if (lineItems.length === 0) lineItems = [{itemId: '', qty: 1}];
                document.getElementById('orderEditModal').dataset.lineItems = JSON.stringify(lineItems);
                this.renderEditOrderLineItems();
            }

            saveOrderEdit() {
                const modal = document.getElementById('orderEditModal');
                const orderId = parseInt(modal.dataset.orderId);
                const customer = document.getElementById('editOrderCustomer').value.trim() || 'Walk-in';
                const notes = document.getElementById('editOrderNotes').value.trim();
                
                // Read line items from DOM
                const lineItems = [];
                let idx = 0;
                while (document.getElementById(`editLineItem_${idx}`) !== null) {
                    const itemId = parseInt(document.getElementById(`editLineItem_${idx}`).value);
                    const qty = parseFloat(document.getElementById(`editLineQty_${idx}`).value) || 0;
                    if (itemId && !isNaN(itemId) && qty > 0) {
                        lineItems.push({itemId, qty, notes: ''});
                    }
                    idx++;
                }
                
                if (lineItems.length === 0) return this.showNotification('Add at least one item', 'error');
                
                // Find and update order
                const o = this.orders.find(x => x.id === orderId);
                if (!o) return this.showNotification('Order not found', 'error');
                
                o.customer = customer;
                o.notes = notes;
                o.lineItems = lineItems;
                
                this.saveToStorage();
                this.closeOrderEditModal();
                this.renderOrdersTable();
                this.showNotification('Order updated', 'success');
                this.logActivity(`Order #${orderId} updated`);
            }

            closeOrderEditModal() {
                document.getElementById('orderEditModal').classList.remove('active');
            }

            closeOrderDetailModal() {
                document.getElementById('orderDetailModal').classList.remove('active');
            }

            printOrder() {
                const o = this.orders.find(x=>x.id===parseInt(document.getElementById('detailOrderId').textContent.replace('#','')));
                if (!o) return;
                const itemsHtml = (o.lineItems || []).map(li => {
                    const item = this.stockItems.find(i => i.id === li.itemId) || { name: 'Deleted', unit: 'pcs' };
                    return `<tr><td>${item.name}</td><td>${li.qty}</td><td>${item.unit}</td></tr>`;
                }).join('');
                
                const printContent = `
                    <html><head><title>Order #${o.id}</title><style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #008187; }
                    .order-header { margin-bottom: 20px; border-bottom: 2px solid #008187; padding-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background: #f5f5f5; }
                    .notes { margin-top: 20px; padding: 10px; background: #f9f9f9; border-left: 4px solid #008187; }
                    </style></head><body>
                    <h1>Order #${o.id}</h1>
                    <div class="order-header">
                        <p><strong>Customer:</strong> ${o.customer}</p>
                        <p><strong>Date:</strong> ${o.date}</p>
                        <p><strong>Status:</strong> ${o.status.toUpperCase()}</p>
                    </div>
                    <h3>Items</h3>
                    <table>
                        <thead><tr><th>Item</th><th>Qty</th><th>Unit</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    ${o.notes ? `<div class="notes"><strong>Notes:</strong><p>${o.notes}</p></div>` : ''}
                    </body></html>
                `;
                
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            applyOrderFilter() { this.renderOrdersTable(); }

            exportOrders() {
                const rows = [['id','customer','items','qty','date','status','notes']];
                this.orders.forEach(o => {
                    let items = '', qty = 0;
                    if (o.lineItems && o.lineItems.length > 0) {
                        items = o.lineItems.map(li => {
                            const item = this.stockItems.find(i => i.id === li.itemId);
                            return `${li.qty}x ${item ? item.name : 'Deleted'}`;
                        }).join('; ');
                        qty = o.lineItems.reduce((sum, li) => sum + (li.qty||0), 0);
                    } else if (o.product && o.qty) {
                        items = o.product;
                        qty = o.qty;
                    }
                    rows.push([o.id,o.customer,items,qty,o.date,o.status,o.notes||'']);
                });
                const csv = rows.map(r=>r.map(c=>`"${(''+(c||'')).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'orders.csv'; a.click(); URL.revokeObjectURL(url);
            }

            exportStockItems() {
                const rows = [ ['id','code','name','group','unit','qty','reorder','created'] ];
                this.stockItems.forEach(i => rows.push([i.id,i.code,i.name,i.group,i.unit,i.qty,i.reorder,i.created]));
                const csv = rows.map(r=>r.map(c=>`"${(''+(c||'')).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'stock_items.csv'; a.click(); URL.revokeObjectURL(url);
            }

            exportStockTransactions() {
                const rows = [ ['id','itemId','itemName','type','qty','date','note'] ];
                this.stockTransactions.forEach(t => {
                    const item = this.stockItems.find(i=>i.id===t.itemId) || { name: '' };
                    rows.push([t.id,t.itemId,item.name,t.type,t.qty,t.date,t.note]);
                });
                const csv = rows.map(r=>r.map(c=>`"${(''+(c||'')).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'stock_transactions.csv'; a.click(); URL.revokeObjectURL(url);
            }

            /* Navigation helpers */
            goHome() {
                // Go to modules page (home)
                this.showModulesPage();
            }

            goBack() {
                // For now, back returns to dashboard
                this.showDashboard();
            }

            toggleMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                const toggle = document.getElementById('mobileMenuToggleTop');
                const toggleDash = document.getElementById('mobileMenuToggle');
                const overlay = document.getElementById('mobileSidebarOverlay');
                
                // Use whichever toggle is visible
                const activeToggle = toggle || toggleDash;
                if (sidebar && activeToggle) {
                    const isOpen = sidebar.classList.toggle('mobile-open');
                    activeToggle.classList.toggle('active');
                    if (overlay) {
                        overlay.classList.toggle('active', isOpen);
                    }
                }
            }

            showTopNav(visible) {
                const nav = document.getElementById('topNav');
                if (!nav) return;
                nav.style.display = visible ? 'flex' : 'none';
            }

            showUserModal(userId = null) {
                const modal = document.getElementById('userModal');
                const title = document.getElementById('userModalTitle');

                if (userId) {
                    title.textContent = 'Edit User';
                    const user = this.users.find(u => u.id === userId);
                    document.getElementById('modalUsername').value = user.username;
                    document.getElementById('modalEmail').value = user.email;
                    document.getElementById('modalPassword').value = '';
                    document.getElementById('modalRole').value = user.role;
                } else {
                    title.textContent = 'Add New User';
                    document.getElementById('modalUsername').value = '';
                    document.getElementById('modalEmail').value = '';
                    document.getElementById('modalPassword').value = '';
                    document.getElementById('modalRole').value = 'staff';
                }

                modal.classList.add('active');
                modal.dataset.userId = userId || '';
            }

            closeModal() {
                document.getElementById('userModal').classList.remove('active');
            }

            saveUser() {
                const username = document.getElementById('modalUsername').value;
                const email = document.getElementById('modalEmail').value;
                const password = document.getElementById('modalPassword').value;
                const role = document.getElementById('modalRole').value;
                const userId = document.getElementById('userModal').dataset.userId;

                if (!username || !email || (!userId && !password)) {
                    this.showNotification('Please complete all required fields', 'error');
                    return;
                }

                if (userId) {
                    const user = this.users.find(u => u.id === parseInt(userId));
                    if (!user) {
                        this.showNotification('User not found', 'error');
                        return;
                    }
                    user.username = username;
                    user.email = email;
                    user.role = role;
                    if (password) {
                        user.password = password;
                    }
                    this.ensureUserPermissionDefaultsForUser(user);
                    this.showNotification('User updated successfully', 'success');
                    this.logActivity(`Updated user ${username}`);
                } else {
                    const nextId = this.users.length ? Math.max(...this.users.map(u => u.id)) + 1 : 1;
                    const newUser = {
                        id: nextId,
                        username,
                        password,
                        email,
                        role,
                        status: 'active',
                        created: new Date().toISOString().split('T')[0],
                        modulePermissions: {},
                        featurePermissions: {}
                    };
                    this.ensureUserPermissionDefaultsForUser(newUser);
                    this.users.push(newUser);
                    this.activePermissionUserId = newUser.id;
                    this.showNotification('User created successfully', 'success');
                    this.logActivity(`Created new user ${username}`);
                }

                this.saveToStorage();
                if (this.currentUser && ((userId && this.currentUser.id === parseInt(userId)) || (!userId && this.currentUser.username === username))) {
                    this.applyNavPermissionVisibility();
                    this.renderModulesGrid();
                }
                this.closeModal();
                this.renderUsersTable();
                this.updateStats();
            }

            editUser(userId) {
                this.showUserModal(userId);
            }

            deleteUser(userId) {
                if (confirm('Are you sure you want to delete this user?')) {
                    const user = this.users.find(u => u.id === userId);
                    this.users = this.users.filter(u => u.id !== userId);
                    this.saveToStorage();
                    this.showNotification(`User ${user.username} deleted`, 'success');
                    this.logActivity(`Deleted user ${user.username}`);
                    this.renderUsersTable();
                    this.updateStats();
                }
            }

            showProductModal() {
                this.openStockEditor();
            }

            logActivity(message) {
                const container = document.getElementById('recentActivities');
                if (!container) return; // Skip if element doesn't exist
                const timestamp = new Date().toLocaleTimeString();
                const activity = document.createElement('p');
                activity.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
                container.insertBefore(activity, container.firstChild);

                // Keep only last 10 activities
                while (container.children.length > 10) {
                    container.removeChild(container.lastChild);
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notificationsContainer');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;

                container.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            refreshCurrentPage() {
                const activePage = document.querySelector('.page.active');
                if (activePage && activePage.id === 'usersPage') this.renderUsersTable();
                if (activePage && activePage.id === 'productsPage') this.renderProducts();
                if (activePage && activePage.id === 'ordersPage') this.renderOrders();
                this.updateStats();
                this.applyNavPermissionVisibility();
                this.renderModulesGrid();
            }

            /* OPERATION METHODS */
            renderOperation() {
                const content = document.getElementById('operationContent');
                if (!content) return;
                this.renderOperationShiftStatus();
                this.renderOperationTable();
                this.renderOperationReports();
                this.initOperationMasterFilters();
                this.renderOperationMasterReport();
                this.showOperationSection(this.activeOperationSection || 'shift');
            }

            renderOperationShiftStatus() {
                const statusEl = document.getElementById('operationShiftStatus');
                if (!statusEl) return;
                const meta = this.operationShiftMeta || {};
                const shiftNumber = meta.id || 1;
                const entryCount = (this.operations || []).length;
                const entryLabel = entryCount ? `${entryCount} record${entryCount === 1 ? '' : 's'}` : 'No records yet';
                if (meta.startedAt && !meta.endedAt) {
                    const startLabel = new Date(meta.startedAt).toLocaleString();
                    statusEl.textContent = `Shift #${shiftNumber} in progress ‚Ä¢ started ${startLabel} ‚Ä¢ ${entryLabel}`;
                } else if (meta.endedAt && !meta.startedAt) {
                    const endLabel = new Date(meta.endedAt).toLocaleString();
                    statusEl.textContent = `Shift #${shiftNumber} ended ${endLabel}. Click "Start New Shift" to begin the next one.`;
                } else if (meta.startedAt && meta.endedAt) {
                    const endLabel = new Date(meta.endedAt).toLocaleString();
                    statusEl.textContent = `Shift #${shiftNumber} closed ${endLabel}.`;
                } else {
                    statusEl.textContent = 'No active shift. Click "Start New Shift" to begin tracking.';
                }
            }

            renderOperationTable() {
                const content = document.getElementById('operationContent');
                if (!content) return;
                if (!this.hasFeatureAccess('operation', 'shiftInput')) {
                    content.innerHTML = '<p style="padding:12px;color:#94a3b8;">Shift input is disabled for your account.</p>';
                    return;
                }

                const q = (document.getElementById('operationReportSearch')?.value || '').toLowerCase();
                const filtered = (this.operations || []).filter(op => {
                    if (!q) return true;
                    const item = this.stockItems.find(i => i.id === op.itemId);
                    return [op.cart, op.time, op.notes, item ? item.name : '']
                        .some(val => (val || '').toLowerCase().includes(q));
                });

                const rows = filtered.map(op => {
                    const item = this.stockItems.find(i => i.id === op.itemId);
                    return `<tr>
                        <td>${op.id}</td>
                        <td>${op.cart || '-'}</td>
                        <td>${op.time || '-'}</td>
                        <td>${item ? item.name : 'Deleted'}</td>
                        <td>${op.quantity || 0}</td>
                        <td>${op.scrap || 0}</td>
                        <td>${op.notes || '-'}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="app.showOperationModal(${op.id})">Edit</button>
                            <button class="btn-small btn-delete" onclick="app.deleteOperation(${op.id})">Delete</button>
                        </td>
                    </tr>`;
                }).join('');

                content.innerHTML = `<table class="table"><thead><tr><th>ID</th><th>Cart #</th><th>Time</th><th>Item</th><th>Qty</th><th>Scrap</th><th>Notes</th><th>Actions</th></tr></thead><tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#777;">No operations found</td></tr>'}</tbody></table>`;
            }

            showOperationSection(section) {
                const accessMap = this.getOperationSectionAccessMap();
                if (!accessMap[section]) {
                    const fallback = Object.keys(accessMap).find(key => accessMap[key]) || null;
                    this.activeOperationSection = fallback;
                } else {
                    this.activeOperationSection = section;
                }
                this.syncOperationSectionAccess();
                if (this.activeOperationSection === 'master') {
                    this.initOperationMasterFilters();
                    this.renderOperationMasterReport();
                }
            }

            getOperationSectionAccessMap() {
                return {
                    shift: this.hasFeatureAccess('operation', 'shiftInput'),
                    history: this.hasFeatureAccess('operation', 'historySearch'),
                    master: this.hasFeatureAccess('operation', 'masterReport')
                };
            }

            syncOperationSectionAccess() {
                const accessMap = this.getOperationSectionAccessMap();
                const availableSections = Object.keys(accessMap).filter(key => accessMap[key]);
                if (this.activeOperationSection && !accessMap[this.activeOperationSection]) {
                    this.activeOperationSection = availableSections[0] || null;
                }
                if (!this.activeOperationSection && availableSections.length) {
                    this.activeOperationSection = availableSections[0];
                }

                const notice = document.getElementById('operationPermissionNotice');
                if (notice) {
                    notice.style.display = this.activeOperationSection ? 'none' : 'block';
                }

                document.querySelectorAll('.operation-subtab-btn').forEach(btn => {
                    const section = btn.dataset.section;
                    const visible = !!accessMap[section];
                    btn.style.display = visible ? 'inline-flex' : 'none';
                    const isActive = section === this.activeOperationSection && visible;
                    btn.classList.toggle('btn-primary', isActive);
                    btn.classList.toggle('btn-secondary', !isActive);
                });

                document.querySelectorAll('.operation-section').forEach(sec => {
                    const section = sec.dataset.section;
                    sec.style.display = section === this.activeOperationSection ? 'block' : 'none';
                });

                const resetBtn = document.getElementById('operationResetBtn');
                if (resetBtn) resetBtn.disabled = !accessMap.shift;
                const startBtn = document.getElementById('operationStartShiftBtn');
                if (startBtn) startBtn.disabled = !accessMap.shift;
                const exportBtn = document.getElementById('operationExportBtn');
                if (exportBtn) exportBtn.disabled = !this.hasFeatureAccess('operation', 'exportTools');
            }

            initOperationMasterFilters() {
                if (!this.hasFeatureAccess('operation', 'masterReport')) return;
                const categorySelect = document.getElementById('operationFilterCategory');
                const itemSelect = document.getElementById('operationFilterItem');
                const shiftSelect = document.getElementById('operationFilterShift');
                if (!categorySelect || !itemSelect || !shiftSelect) return;

                const prevCategory = categorySelect.value;
                const categories = Array.from(new Set((this.stockItems || []).map(i => i.group || 'Uncategorized'))).sort((a, b) => a.localeCompare(b));
                categorySelect.innerHTML = '<option value="">All categories</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                if (prevCategory && categories.includes(prevCategory)) {
                    categorySelect.value = prevCategory;
                }

                const prevItem = itemSelect.value;
                const items = (this.stockItems || []).slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                itemSelect.innerHTML = '<option value="">All items</option>' + items.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                if (prevItem && items.some(item => String(item.id) === prevItem)) {
                    itemSelect.value = prevItem;
                }

                const prevShift = shiftSelect.value;
                const shiftOptions = ['<option value="">All shifts</option>', '<option value="current">Current Shift</option>'];
                (this.productionArchives || []).forEach(archive => {
                    const label = archive.createdAt ? new Date(archive.createdAt).toLocaleString() : 'Unknown date';
                    shiftOptions.push(`<option value="archive-${archive.id}">Archive #${archive.id} (${label})</option>`);
                });
                shiftSelect.innerHTML = shiftOptions.join('');
                const validShiftValues = new Set(['', 'current', ...(this.productionArchives || []).map(a => `archive-${a.id}`)]);
                shiftSelect.value = validShiftValues.has(prevShift) ? prevShift : '';
            }

            getFilteredOperationMasterData() {
                if (!this.hasFeatureAccess('operation', 'masterReport')) {
                    return [];
                }
                const entries = this.getOperationHistoryEntries();
                const startVal = document.getElementById('operationFilterStart')?.value;
                const endVal = document.getElementById('operationFilterEnd')?.value;
                const categoryVal = document.getElementById('operationFilterCategory')?.value || '';
                const itemValRaw = document.getElementById('operationFilterItem')?.value;
                const itemVal = itemValRaw ? parseInt(itemValRaw) : null;
                const shiftVal = document.getElementById('operationFilterShift')?.value || '';
                const sortMode = document.getElementById('operationSortBy')?.value || 'dateDesc';

                const startTs = startVal ? new Date(startVal + 'T00:00:00').getTime() : null;
                const endTs = endVal ? new Date(endVal + 'T23:59:59').getTime() : null;

                let filtered = entries.filter(entry => {
                    if (startTs && entry.rawDate < startTs) return false;
                    if (endTs && entry.rawDate > endTs) return false;
                    if (categoryVal && entry.category !== categoryVal) return false;
                    if (itemVal && parseInt(entry.itemId) !== itemVal) return false;
                    if (shiftVal && entry.sourceKey !== shiftVal) return false;
                    return true;
                });

                const comparator = {
                    dateAsc: (a, b) => (a.rawDate || 0) - (b.rawDate || 0),
                    dateDesc: (a, b) => (b.rawDate || 0) - (a.rawDate || 0),
                    category: (a, b) => (a.category || '').localeCompare(b.category || '') || ((b.rawDate || 0) - (a.rawDate || 0)),
                    item: (a, b) => (a.itemName || '').localeCompare(b.itemName || '') || ((b.rawDate || 0) - (a.rawDate || 0)),
                    shift: (a, b) => (a.sourceLabel || '').localeCompare(b.sourceLabel || '') || ((b.rawDate || 0) - (a.rawDate || 0))
                };

                const sorter = comparator[sortMode] || comparator.dateDesc;
                filtered = filtered.slice().sort(sorter);
                return filtered;
            }

            renderOperationMasterReport() {
                const container = document.getElementById('operationMasterTable');
                const counter = document.getElementById('operationMasterCount');
                if (!container || !counter) return;
                if (!this.hasFeatureAccess('operation', 'masterReport')) {
                    counter.textContent = '0 records';
                    container.innerHTML = '<p style="color:#94a3b8;">Master report is disabled for this user.</p>';
                    return;
                }
                const data = this.getFilteredOperationMasterData();
                counter.textContent = `${data.length} record${data.length === 1 ? '' : 's'}`;

                const rows = data.map(entry => `
                    <tr>
                        <td>${entry.timeLabel}</td>
                        <td>${entry.itemName}</td>
                        <td>${entry.category || '-'}</td>
                        <td>${entry.quantity}</td>
                        <td>${entry.scrap}</td>
                        <td>${entry.cart}</td>
                        <td>${entry.sourceLabel}</td>
                        <td>${entry.notes || '-'}</td>
                    </tr>
                `).join('');

                container.innerHTML = `<table class="table"><thead><tr><th>Date & Time</th><th>Item</th><th>Category</th><th>Qty</th><th>Scrap</th><th>Cart</th><th>Shift</th><th>Notes</th></tr></thead><tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#777;">No data matches the selected filters</td></tr>'}</tbody></table>`;
            }

            exportOperationMasterReport() {
                if (!this.hasFeatureAccess('operation', 'exportTools')) {
                    this.showNotification('Export permission is disabled for this user', 'error');
                    return;
                }
                const data = this.getFilteredOperationMasterData();
                if (!data.length) {
                    this.showNotification('No records to export with current filters', 'error');
                    return;
                }

                const header = ['Date & Time', 'Item', 'Category', 'Quantity', 'Scrap', 'Cart', 'Shift', 'Notes'];
                const lines = [header];
                data.forEach(entry => {
                    lines.push([
                        entry.timeLabel,
                        entry.itemName,
                        entry.category || '',
                        entry.quantity,
                        entry.scrap,
                        entry.cart,
                        entry.sourceLabel,
                        entry.notes || ''
                    ]);
                });

                const csv = lines.map(row => row.map(col => `"${('' + (col ?? '')).replace(/"/g, '""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `operation_master_report_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Operation report exported', 'success');
            }

            buildHistoryEntry(record, sourceLabel, sortDate, sourceKey = 'current') {
                const lookupItem = record.itemId ? this.stockItems.find(i => i.id === record.itemId) : null;
                const itemName = record.itemName || (lookupItem ? lookupItem.name : '') || 'Unknown item';
                const category = record.itemCategory || (lookupItem ? (lookupItem.group || 'Uncategorized') : 'Uncategorized');
                let rawDate = Date.now();
                if (record.recordedAt) {
                    const ts = new Date(record.recordedAt).getTime();
                    if (!isNaN(ts)) rawDate = ts;
                } else if (sortDate) {
                    const ts = new Date(sortDate).getTime();
                    if (!isNaN(ts)) rawDate = ts;
                }
                let timeLabel = '-';
                if (!isNaN(rawDate)) {
                    timeLabel = new Date(rawDate).toLocaleString();
                }
                if (record.time && (!record.recordedAt || (record.recordedAt && record.recordedAt.indexOf('T') === -1))) {
                    timeLabel = `${timeLabel}${record.time ? ' ‚Ä¢ ' + record.time : ''}`;
                }
                return {
                    ref: record.id || '',
                    cart: record.cart || '-',
                    itemName,
                    itemId: record.itemId || (lookupItem ? lookupItem.id : null),
                    category,
                    quantity: record.quantity || 0,
                    scrap: record.scrap || 0,
                    notes: record.notes || '',
                    timeLabel,
                    sourceLabel,
                    sourceKey,
                    rawDate,
                    sortKey: isNaN(rawDate) ? 0 : rawDate
                };
            }

            getOperationHistoryEntries() {
                const entries = [];
                (this.operations || []).forEach(op => {
                    const entry = this.buildHistoryEntry(op, 'Current Shift', op.recordedAt, 'current');
                    entry.ref = op.id || entry.ref || '-';
                    entries.push(entry);
                });

                (this.productionArchives || []).forEach(archive => {
                    const sourceLabel = `Archive #${archive.id}${archive.createdAt ? ' (' + new Date(archive.createdAt).toLocaleString() + ')' : ''}`;
                    const sourceKey = `archive-${archive.id}`;
                    (archive.operations || []).forEach((op, idx) => {
                        const entry = this.buildHistoryEntry(op, sourceLabel, archive.createdAt || op.recordedAt || op.time, sourceKey);
                        entry.ref = op.id || `A${archive.id}-${idx + 1}`;
                        entries.push(entry);
                    });
                });

                return entries.sort((a, b) => b.sortKey - a.sortKey);
            }

            renderOperationReports() {
                const container = document.getElementById('operationReportsContainer');
                if (!container) return;
                if (!this.hasFeatureAccess('operation', 'historySearch')) {
                    container.innerHTML = '<p style="color:#94a3b8;">History access is disabled for this user.</p>';
                    return;
                }
                const q = (document.getElementById('operationHistorySearch')?.value || '').toLowerCase();
                const entries = this.getOperationHistoryEntries();
                const filtered = entries.filter(entry => {
                    if (!q) return true;
                    return [entry.ref, entry.cart, entry.itemName, entry.notes, entry.sourceLabel, entry.timeLabel]
                        .some(val => (val || '').toLowerCase().includes(q));
                });

                const rows = filtered.map(entry => `
                    <tr>
                        <td>${entry.ref}</td>
                        <td>${entry.cart}</td>
                        <td>${entry.itemName}</td>
                        <td>${entry.quantity}</td>
                        <td>${entry.scrap}</td>
                        <td>${entry.notes || '-'}</td>
                        <td>${entry.timeLabel}</td>
                        <td>${entry.sourceLabel}</td>
                    </tr>
                `).join('');

                container.innerHTML = `<table class="table"><thead><tr><th>Ref</th><th>Cart</th><th>Item</th><th>Qty</th><th>Scrap</th><th>Notes</th><th>Recorded</th><th>Source</th></tr></thead><tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#777;">No history found</td></tr>'}</tbody></table>`;
            }

            showOperationModal(opId = null) {
                if (!this.hasFeatureAccess('operation', 'shiftInput')) {
                    this.showNotification('You do not have permission to edit operations', 'error');
                    return;
                }
                const modal = document.getElementById('operationModal');
                const title = document.getElementById('operationModalTitle');

                // Populate item dropdown
                const itemSelect = document.getElementById('modalOperationItem');
                itemSelect.innerHTML = '<option value="">Select an item</option>';
                this.stockItems.forEach(item => {
                    itemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });

                if (opId) {
                    title.textContent = 'Edit Operation';
                    const op = this.operations.find(o => o.id === opId);
                    document.getElementById('modalOperationCart').value = op.cart || '';
                    document.getElementById('modalOperationTime').value = op.time || '';
                    document.getElementById('modalOperationItem').value = op.itemId || '';
                    document.getElementById('modalOperationQuantity').value = op.quantity || 0;
                    document.getElementById('modalOperationScrap').value = op.scrap || 0;
                    document.getElementById('modalOperationNotes').value = op.notes || '';
                } else {
                    title.textContent = 'Add Operation';
                    document.getElementById('modalOperationCart').value = '';
                    document.getElementById('modalOperationTime').value = '';
                    document.getElementById('modalOperationItem').value = '';
                    document.getElementById('modalOperationQuantity').value = '';
                    document.getElementById('modalOperationScrap').value = '';
                    document.getElementById('modalOperationNotes').value = '';
                }

                modal.classList.add('active');
                modal.dataset.opId = opId || '';
            }

            saveOperation() {
                if (!this.hasFeatureAccess('operation', 'shiftInput')) {
                    this.showNotification('You do not have permission to record operations', 'error');
                    return;
                }
                const cart = document.getElementById('modalOperationCart').value;
                const time = document.getElementById('modalOperationTime').value;
                const itemId = parseInt(document.getElementById('modalOperationItem').value);
                const quantity = parseInt(document.getElementById('modalOperationQuantity').value) || 0;
                const scrap = parseInt(document.getElementById('modalOperationScrap').value) || 0;
                const notes = document.getElementById('modalOperationNotes').value;
                const opId = document.getElementById('operationModal').dataset.opId;

                if (!cart || !time || !itemId || quantity < 0) {
                    this.showNotification('Please fill all required fields', 'error');
                    return;
                }

                if (opId) {
                    const op = this.operations.find(o => o.id === parseInt(opId));
                    op.cart = cart;
                    op.time = time;
                    op.itemId = itemId;
                    op.quantity = quantity;
                    op.scrap = scrap;
                    op.notes = notes;
                    op.recordedAt = op.recordedAt || new Date().toISOString();
                    this.showNotification('Operation updated', 'success');
                } else {
                    const newOp = {
                        id: this.operations.length > 0 ? Math.max(...this.operations.map(o => o.id)) + 1 : 1,
                        cart,
                        time,
                        itemId,
                        quantity,
                        scrap,
                        notes,
                        recordedAt: new Date().toISOString()
                    };
                    this.operations.push(newOp);
                    
                    // Deduct from stock and create transaction
                    const item = this.stockItems.find(i => i.id === itemId);
                    if (item) {
                        item.qty = item.qty - quantity;
                        const txId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t=>t.id))+1 : 1;
                        this.stockTransactions.push({ id: txId, itemId: item.id, type: 'operation', qty: quantity, date: new Date().toISOString(), note: `Operation #${newOp.id} cart ${cart}` });
                    }
                    
                    this.showNotification('Operation added and stock updated', 'success');
                }

                this.saveToStorage();
                this.closeOperationModal();
                this.renderOperationTable();
                this.renderOperationReports();
                this.initOperationMasterFilters();
                this.renderOperationMasterReport();
                this.renderOperationShiftStatus();
                this.renderStockTable();
                this.renderStockTransactions();
            }

            deleteOperation(opId) {
                if (!this.hasFeatureAccess('operation', 'shiftInput')) {
                    this.showNotification('You do not have permission to delete operations', 'error');
                    return;
                }
                if (confirm('Delete this operation?')) {
                    this.operations = this.operations.filter(o => o.id !== opId);
                    this.saveToStorage();
                    this.showNotification('Operation deleted', 'success');
                    this.renderOperationTable();
                    this.renderOperationReports();
                    this.initOperationMasterFilters();
                    this.renderOperationMasterReport();
                    this.renderOperationShiftStatus();
                }
            }

            closeOperationModal() {
                document.getElementById('operationModal').classList.remove('active');
            }

            resetOperationData(options = {}) {
                if (!this.hasFeatureAccess('operation', 'shiftInput')) {
                    this.showNotification('You do not have permission to reset shifts', 'error');
                    return false;
                }
                if (typeof options === 'boolean') {
                    options = { skipConfirm: options };
                }
                const { skipConfirm = false, suppressNotification = false, preserveShiftMeta = false } = options;
                const hasOperations = Array.isArray(this.operations) && this.operations.length > 0;
                if (!hasOperations) {
                    if (!suppressNotification) {
                        this.showNotification('No operations to reset', 'info');
                    }
                    return false;
                }

                if (!skipConfirm) {
                    const proceed = confirm('This will archive and clear all operation records for the current shift. Continue?');
                    if (!proceed) {
                        return false;
                    }
                }

                const snapshot = typeof this.archiveCurrentProductionState === 'function'
                    ? this.archiveCurrentProductionState()
                    : null;

                this.operations = [];
                if (!preserveShiftMeta) {
                    this.operationShiftMeta = {
                        id: this.operationShiftMeta?.id || 1,
                        startedAt: null,
                        endedAt: new Date().toISOString()
                    };
                }
                this.saveToStorage();
                this.renderOperationTable();
                this.renderOperationReports();
                this.initOperationMasterFilters();
                this.renderOperationMasterReport();
                this.renderOperationShiftStatus();

                if (!suppressNotification) {
                    const message = snapshot ? 'Operation shift archived and reset' : 'Operations reset';
                    this.showNotification(message, 'success');
                }
                return true;
            }

            startOperationShift() {
                if (!this.hasFeatureAccess('operation', 'shiftInput')) {
                    this.showNotification('You do not have permission to start shifts', 'error');
                    return;
                }
                const hasOperations = Array.isArray(this.operations) && this.operations.length > 0;
                if (hasOperations) {
                    const proceed = confirm('This will archive the current shift data and immediately start a new shift. Continue?');
                    if (!proceed) {
                        return;
                    }
                    const wasReset = this.resetOperationData({ skipConfirm: true, suppressNotification: true, preserveShiftMeta: true });
                    if (!wasReset) {
                        return;
                    }
                }

                const nextId = (this.operationShiftMeta?.id || 0) + 1;
                this.operationShiftMeta = {
                    id: nextId,
                    startedAt: new Date().toISOString(),
                    endedAt: null
                };
                this.saveToStorage();
                this.renderOperationShiftStatus();
                this.showNotification(`Shift #${nextId} started`, 'success');
            }

            /* PACKAGING METHODS */
            renderPackaging() {
                const content = document.getElementById('packagingContent');
                if (!content) return;
                this.renderPackagingTable();
                this.renderPackagingReports();
                this.initPackagingMasterFilters();
                this.renderPackagingMasterReport();
            }

            renderPackagingTable() {
                const content = document.getElementById('packagingContent');
                if (!content) return;

                const q = (document.getElementById('packagingReportSearch')?.value || '').toLowerCase();
                const filtered = (this.packaging || []).filter(pkg => {
                    if (!q) return true;
                    const item = this.stockItems.find(i => i.id === pkg.itemId);
                    return [pkg.cart, pkg.time, pkg.notes, item ? item.name : '']
                        .some(val => (val || '').toLowerCase().includes(q));
                });

                const rows = filtered.map(pkg => {
                    const item = this.stockItems.find(i => i.id === pkg.itemId);
                    return `<tr>
                        <td>${pkg.id}</td>
                        <td>${pkg.cart || '-'}</td>
                        <td>${pkg.time || '-'}</td>
                        <td>${item ? item.name : 'Deleted'}</td>
                        <td>${pkg.quantity || 0}</td>
                        <td>${pkg.scrap || 0}</td>
                        <td>${pkg.notes || '-'}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="app.showPackagingModal(${pkg.id})">Edit</button>
                            <button class="btn-small btn-delete" onclick="app.deletePackaging(${pkg.id})">Delete</button>
                        </td>
                    </tr>`;
                }).join('');

                content.innerHTML = `<table class="table"><thead><tr><th>ID</th><th>Cart #</th><th>Time</th><th>Item</th><th>Qty</th><th>Scrap</th><th>Notes</th><th>Actions</th></tr></thead><tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#777;">No packaging records found</td></tr>'}</tbody></table>`;
            }

            getPackagingHistoryEntries() {
                const entries = [];
                (this.packaging || []).forEach(pkg => {
                    const entry = this.buildHistoryEntry(pkg, 'Current Shift', pkg.recordedAt, 'current');
                    entry.ref = pkg.id || entry.ref || '-';
                    entries.push(entry);
                });

                (this.productionArchives || []).forEach(archive => {
                    const sourceLabel = `Archive #${archive.id}${archive.createdAt ? ' (' + new Date(archive.createdAt).toLocaleString() + ')' : ''}`;
                    const sourceKey = `archive-${archive.id}`;
                    (archive.packaging || []).forEach((pkg, idx) => {
                        const entry = this.buildHistoryEntry(pkg, sourceLabel, archive.createdAt || pkg.recordedAt || pkg.time, sourceKey);
                        entry.ref = pkg.id || `P${archive.id}-${idx + 1}`;
                        entries.push(entry);
                    });
                });

                return entries.sort((a, b) => b.sortKey - a.sortKey);
            }

            renderPackagingReports() {
                const container = document.getElementById('packagingReportsContainer');
                if (!container) return;
                const q = (document.getElementById('packagingHistorySearch')?.value || '').toLowerCase();
                const entries = this.getPackagingHistoryEntries();
                const filtered = entries.filter(entry => {
                    if (!q) return true;
                    return [entry.ref, entry.cart, entry.itemName, entry.notes, entry.sourceLabel, entry.timeLabel]
                        .some(val => (val || '').toLowerCase().includes(q));
                });

                const rows = filtered.map(entry => `
                    <tr>
                        <td>${entry.ref}</td>
                        <td>${entry.cart}</td>
                        <td>${entry.itemName}</td>
                        <td>${entry.quantity}</td>
                        <td>${entry.scrap}</td>
                        <td>${entry.notes || '-'}</td>
                        <td>${entry.timeLabel}</td>
                        <td>${entry.sourceLabel}</td>
                    </tr>
                `).join('');

                container.innerHTML = `<table class="table"><thead><tr><th>Ref</th><th>Cart</th><th>Item</th><th>Qty</th><th>Scrap</th><th>Notes</th><th>Recorded</th><th>Source</th></tr></thead><tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#777;">No history found</td></tr>'}</tbody></table>`;
            }

            initPackagingMasterFilters() {
                const categorySelect = document.getElementById('packagingFilterCategory');
                const itemSelect = document.getElementById('packagingFilterItem');
                const shiftSelect = document.getElementById('packagingFilterShift');
                if (!categorySelect || !itemSelect || !shiftSelect) return;

                const prevCategory = categorySelect.value;
                const categories = Array.from(new Set((this.stockItems || []).map(i => i.group || 'Uncategorized'))).sort((a, b) => a.localeCompare(b));
                categorySelect.innerHTML = '<option value="">All categories</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                if (prevCategory && categories.includes(prevCategory)) {
                    categorySelect.value = prevCategory;
                }

                const prevItem = itemSelect.value;
                const items = (this.stockItems || []).slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                itemSelect.innerHTML = '<option value="">All items</option>' + items.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                if (prevItem && items.some(item => String(item.id) === prevItem)) {
                    itemSelect.value = prevItem;
                }

                const prevShift = shiftSelect.value;
                const shiftOptions = ['<option value="">All shifts</option>', '<option value="current">Current Shift</option>'];
                (this.productionArchives || []).forEach(archive => {
                    const label = archive.createdAt ? new Date(archive.createdAt).toLocaleString() : 'Unknown date';
                    shiftOptions.push(`<option value="archive-${archive.id}">Archive #${archive.id} (${label})</option>`);
                });
                shiftSelect.innerHTML = shiftOptions.join('');
                const validShiftValues = new Set(['', 'current', ...(this.productionArchives || []).map(a => `archive-${a.id}`)]);
                shiftSelect.value = validShiftValues.has(prevShift) ? prevShift : '';
            }

            getFilteredPackagingMasterData() {
                const entries = this.getPackagingHistoryEntries();
                const startVal = document.getElementById('packagingFilterStart')?.value;
                const endVal = document.getElementById('packagingFilterEnd')?.value;
                const categoryVal = document.getElementById('packagingFilterCategory')?.value || '';
                const itemValRaw = document.getElementById('packagingFilterItem')?.value;
                const itemVal = itemValRaw ? parseInt(itemValRaw) : null;
                const shiftVal = document.getElementById('packagingFilterShift')?.value || '';
                const sortMode = document.getElementById('packagingSortBy')?.value || 'dateDesc';

                const startTs = startVal ? new Date(startVal + 'T00:00:00').getTime() : null;
                const endTs = endVal ? new Date(endVal + 'T23:59:59').getTime() : null;

                let filtered = entries.filter(entry => {
                    if (startTs && entry.rawDate < startTs) return false;
                    if (endTs && entry.rawDate > endTs) return false;
                    if (categoryVal && entry.category !== categoryVal) return false;
                    if (itemVal && parseInt(entry.itemId) !== itemVal) return false;
                    if (shiftVal && entry.sourceKey !== shiftVal) return false;
                    return true;
                });

                const comparator = {
                    dateAsc: (a, b) => (a.rawDate || 0) - (b.rawDate || 0),
                    dateDesc: (a, b) => (b.rawDate || 0) - (a.rawDate || 0),
                    category: (a, b) => (a.category || '').localeCompare(b.category || '') || ((b.rawDate || 0) - (a.rawDate || 0)),
                    item: (a, b) => (a.itemName || '').localeCompare(b.itemName || '') || ((b.rawDate || 0) - (a.rawDate || 0)),
                    shift: (a, b) => (a.sourceLabel || '').localeCompare(b.sourceLabel || '') || ((b.rawDate || 0) - (a.rawDate || 0))
                };

                const sorter = comparator[sortMode] || comparator.dateDesc;
                filtered = filtered.slice().sort(sorter);
                return filtered;
            }

            renderPackagingMasterReport() {
                const container = document.getElementById('packagingMasterTable');
                const counter = document.getElementById('packagingMasterCount');
                if (!container || !counter) return;
                const data = this.getFilteredPackagingMasterData();
                counter.textContent = `${data.length} record${data.length === 1 ? '' : 's'}`;

                const rows = data.map(entry => `
                    <tr>
                        <td>${entry.timeLabel}</td>
                        <td>${entry.itemName}</td>
                        <td>${entry.category || '-'}</td>
                        <td>${entry.quantity}</td>
                        <td>${entry.scrap}</td>
                        <td>${entry.cart}</td>
                        <td>${entry.sourceLabel}</td>
                        <td>${entry.notes || '-'}</td>
                    </tr>
                `).join('');

                container.innerHTML = `<table class="table"><thead><tr><th>Date & Time</th><th>Item</th><th>Category</th><th>Qty</th><th>Scrap</th><th>Cart</th><th>Shift</th><th>Notes</th></tr></thead><tbody>${rows || '<tr><td colspan="8" style="text-align:center;color:#777;">No data matches the selected filters</td></tr>'}</tbody></table>`;
            }

            exportPackagingMasterReport() {
                const data = this.getFilteredPackagingMasterData();
                if (!data.length) {
                    this.showNotification('No records to export with current filters', 'error');
                    return;
                }

                const header = ['Date & Time', 'Item', 'Category', 'Quantity', 'Scrap', 'Cart', 'Shift', 'Notes'];
                const lines = [header];
                data.forEach(entry => {
                    lines.push([
                        entry.timeLabel,
                        entry.itemName,
                        entry.category || '',
                        entry.quantity,
                        entry.scrap,
                        entry.cart,
                        entry.sourceLabel,
                        entry.notes || ''
                    ]);
                });

                const csv = lines.map(row => row.map(col => `"${('' + (col ?? '')).replace(/"/g, '""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `packaging_master_report_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Packaging report exported', 'success');
            }

            showPackagingModal(pkgId = null) {
                const modal = document.getElementById('packagingModal');
                const title = document.getElementById('packagingModalTitle');

                // Populate item dropdown
                const itemSelect = document.getElementById('modalPackagingItem');
                itemSelect.innerHTML = '<option value="">Select an item</option>';
                this.stockItems.forEach(item => {
                    itemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });

                if (pkgId) {
                    title.textContent = 'Edit Packaging';
                    const pkg = this.packaging.find(p => p.id === pkgId);
                    document.getElementById('modalPackagingCart').value = pkg.cart || '';
                    document.getElementById('modalPackagingTime').value = pkg.time || '';
                    document.getElementById('modalPackagingItem').value = pkg.itemId || '';
                    document.getElementById('modalPackagingQuantity').value = pkg.quantity || 0;
                    document.getElementById('modalPackagingScrap').value = pkg.scrap || 0;
                    document.getElementById('modalPackagingNotes').value = pkg.notes || '';
                } else {
                    title.textContent = 'Add Packaging';
                    document.getElementById('modalPackagingCart').value = '';
                    document.getElementById('modalPackagingTime').value = '';
                    document.getElementById('modalPackagingItem').value = '';
                    document.getElementById('modalPackagingQuantity').value = '';
                    document.getElementById('modalPackagingScrap').value = '';
                    document.getElementById('modalPackagingNotes').value = '';
                }

                modal.classList.add('active');
                modal.dataset.pkgId = pkgId || '';
            }

            savePackaging() {
                const cart = document.getElementById('modalPackagingCart').value;
                const time = document.getElementById('modalPackagingTime').value;
                const itemId = parseInt(document.getElementById('modalPackagingItem').value);
                const quantity = parseInt(document.getElementById('modalPackagingQuantity').value) || 0;
                const scrap = parseInt(document.getElementById('modalPackagingScrap').value) || 0;
                const notes = document.getElementById('modalPackagingNotes').value;
                const pkgId = document.getElementById('packagingModal').dataset.pkgId;

                if (!cart || !time || !itemId || quantity < 0) {
                    this.showNotification('Please fill all required fields', 'error');
                    return;
                }

                if (pkgId) {
                    const pkg = this.packaging.find(p => p.id === parseInt(pkgId));
                    pkg.cart = cart;
                    pkg.time = time;
                    pkg.itemId = itemId;
                    pkg.quantity = quantity;
                    pkg.scrap = scrap;
                    pkg.notes = notes;
                    pkg.recordedAt = pkg.recordedAt || new Date().toISOString();
                    this.showNotification('Packaging updated', 'success');
                } else {
                    const newPkg = {
                        id: this.packaging.length > 0 ? Math.max(...this.packaging.map(p => p.id)) + 1 : 1,
                        cart,
                        time,
                        itemId,
                        quantity,
                        scrap,
                        notes,
                        recordedAt: new Date().toISOString()
                    };
                    this.packaging.push(newPkg);
                    
                    // Add to stock and create transaction
                    const item = this.stockItems.find(i => i.id === itemId);
                    if (item) {
                        item.qty = item.qty + quantity;
                        const txId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t=>t.id))+1 : 1;
                        this.stockTransactions.push({ id: txId, itemId: item.id, type: 'packaging', qty: quantity, date: new Date().toISOString(), note: `Packaging #${newPkg.id} cart ${cart}` });
                    }
                    
                    this.showNotification('Packaging added and stock increased', 'success');
                }

                this.saveToStorage();
                this.closePackagingModal();
                this.renderPackagingTable();
                this.renderPackagingReports();
                this.initPackagingMasterFilters();
                this.renderPackagingMasterReport();
                this.renderStockTable();
                this.renderStockTransactions();
            }

            deletePackaging(pkgId) {
                if (confirm('Delete this packaging?')) {
                    this.packaging = this.packaging.filter(p => p.id !== pkgId);
                    this.saveToStorage();
                    this.showNotification('Packaging deleted', 'success');
                    this.renderPackagingTable();
                    this.renderPackagingReports();
                    this.initPackagingMasterFilters();
                    this.renderPackagingMasterReport();
                }
            }

            closePackagingModal() {
                document.getElementById('packagingModal').classList.remove('active');
            }

            resetPackagingData() {
                if (!this.packaging || this.packaging.length === 0) {
                    this.showNotification('No packaging entries to reset', 'info');
                    return;
                }

                if (!confirm('This will archive and clear all packaging records for the current shift. Continue?')) {
                    return;
                }

                const snapshot = typeof this.archiveCurrentProductionState === 'function'
                    ? this.archiveCurrentProductionState()
                    : null;

                this.packaging = [];
                this.saveToStorage();
                this.renderPackagingTable();
                this.renderPackagingReports();
                this.initPackagingMasterFilters();
                this.renderPackagingMasterReport();

                const message = snapshot ? 'Packaging shift archived and reset' : 'Packaging reset';
                this.showNotification(message, 'success');
            }

            /* PRODUCTION METHODS */
            handleOdooImport(evt) {
                const file = evt?.target?.files?.[0];
                if (!file) {
                    this.showNotification('Please select an Odoo export file', 'error');
                    return;
                }

                const extension = (file.name.split('.').pop() || '').toLowerCase();
                const isCsv = extension === 'csv';
                const reader = new FileReader();
                const normalize = (val) => (val || '').toString().replace(/\s+/g, ' ').trim().toLowerCase();
                const stripCodePrefix = (val) => {
                    if (!val) return '';
                    const str = val.toString().trim();
                    const match = str.match(/^\s*\[[^\]]+\]\s*(.+)$/);
                    return match ? match[1].trim() : str;
                };

                reader.onload = (e) => {
                    try {
                        let rows = [];
                        if (isCsv) {
                            const text = e.target.result;
                            const wb = XLSX.read(text, { type: 'string' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
                        } else {
                            const data = new Uint8Array(e.target.result);
                            const wb = XLSX.read(data, { type: 'array' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
                        }

                        if (!rows.length) {
                            this.showNotification('No rows detected in file', 'error');
                            return;
                        }

                        const requirementMap = new Map();
                        const unmatched = [];
                        const autoCreatedItems = [];
                        let matchedCount = 0;

                        const parseNumber = (value) => {
                            if (value === undefined || value === null) return NaN;
                            if (typeof value === 'number') return value;
                            if (typeof value === 'string') {
                                const cleaned = value.replace(/[\s,]+/g, '').replace(/[^0-9.\-]/g, '');
                                if (!cleaned) return NaN;
                                return parseFloat(cleaned);
                            }
                            return NaN;
                        };

                        const isSummaryLabel = (text) => {
                            if (!text) return false;
                            const normalized = text.trim().toLowerCase();
                            return normalized === 'total' || normalized === 'qty ordered' || normalized === 'quantity';
                        };

                        const ensureStockItem = (code, label) => {
                            const normalizedLabel = normalize(label);
                            if (!code && !normalizedLabel) return null;
                            let existing = null;
                            if (code) {
                                existing = this.stockItems.find(item => (item.code || '').toLowerCase() === code.toLowerCase());
                            }
                            if (!existing && normalizedLabel) {
                                existing = this.stockItems.find(item => normalize(item.name) === normalizedLabel);
                            }
                            if (existing) return existing;

                            if (!label) return null;
                            const newId = this.stockItems.length ? Math.max(...this.stockItems.map(i => i.id)) + 1 : 1;
                            const newItem = {
                                id: newId,
                                name: label,
                                code: code || '',
                                group: 'FG',
                                unit: 'pcs',
                                qty: 0,
                                reorder: 0,
                                created: new Date().toISOString().split('T')[0],
                                canBeSold: true,
                                isSemiProduct: false,
                                isPack: false,
                                packItemId: null,
                                packQuantity: null,
                                autoCreatedFromOdoo: true
                            };
                            this.stockItems.push(newItem);
                            autoCreatedItems.push(newItem);
                            return newItem;
                        };

                        const pickField = (norm, candidates) => {
                            for (const candidate of candidates) {
                                if (candidate in norm && norm[candidate] !== undefined && norm[candidate] !== null) {
                                    return norm[candidate];
                                }
                            }
                            return undefined;
                        };

                        rows.forEach(row => {
                            const norm = {};
                            Object.keys(row).forEach((key, idx) => {
                                const normalizedKey = key ? key.toString().trim().toLowerCase() : `__col_${idx}`;
                                norm[normalizedKey] = row[key];
                            });

                            const preferredProduct = (pickField(norm, ['item', 'items', 'product', 'product name', 'description', 'name']) || '').toString().trim();
                            const fallbackProduct = (() => {
                                for (const originalKey of Object.keys(row)) {
                                    const value = row[originalKey];
                                    if (typeof value !== 'string') continue;
                                    const trimmed = value.trim();
                                    if (!trimmed || isSummaryLabel(trimmed)) continue;
                                    return trimmed;
                                }
                                return '';
                            })();

                            const rawProduct = preferredProduct || fallbackProduct;
                            const rawNameWithoutCode = stripCodePrefix(rawProduct);
                            let code = (norm['code'] || norm['product code'] || norm['internal reference'] || norm['default_code'] || norm['default code'] || '').toString().trim();
                            if (!code && rawProduct) {
                                const match = rawProduct.match(/\[([^\]]+)\]/);
                                if (match) code = match[1].trim();
                            }
                            const chosenName = rawNameWithoutCode || rawProduct || code;
                            const normalizedRowName = normalize(chosenName);

                            const qtyCandidate = pickField(norm, ['qty required', 'qty ordered', 'qty', 'quantity', 'ordered quantity', 'reserved', 'demand', 'forecast', 'to produce', 'done', 'planned']);
                            let qty = parseNumber(qtyCandidate);
                            if (isNaN(qty)) {
                                for (const originalKey of Object.keys(row)) {
                                    const parsed = parseNumber(row[originalKey]);
                                    if (!isNaN(parsed)) { qty = parsed; break; }
                                }
                            }

                            if (!chosenName || isSummaryLabel(chosenName) || isNaN(qty) || qty <= 0) return;

                            let matchedItem = null;
                            if (code) {
                                matchedItem = this.stockItems.find(item => (item.code || '').toLowerCase() === code.toLowerCase());
                            }
                            if (!matchedItem && normalizedRowName) {
                                matchedItem = this.stockItems.find(item => normalize(item.name) === normalizedRowName);
                            }

                            if (!matchedItem) {
                                matchedItem = ensureStockItem(code, chosenName);
                            }

                            if (!matchedItem) {
                                unmatched.push({ code: code || '', name: chosenName, qty });
                                return;
                            }

                            let targetItemId = matchedItem.id;
                            let effectiveQty = qty;
                            let conversionNote = null;

                            if (matchedItem.isPack && matchedItem.packItemId && matchedItem.packQuantity) {
                                targetItemId = matchedItem.packItemId;
                                effectiveQty = qty * matchedItem.packQuantity;
                                const innerItem = this.stockItems.find(i => i.id === matchedItem.packItemId);
                                const unitLabel = innerItem ? (innerItem.unit || 'pcs') : 'pcs';
                                conversionNote = `${qty} pack(s) √ó ${matchedItem.packQuantity} = ${effectiveQty} ${unitLabel}`;
                            }

                            const bucket = requirementMap.get(targetItemId) || { itemId: targetItemId, qty: 0, details: [] };
                            bucket.qty += effectiveQty;
                            bucket.details.push({
                                code: code || matchedItem.code || '',
                                name: chosenName || matchedItem.name,
                                originalQty: qty,
                                convertedQty: effectiveQty,
                                conversionNote
                            });
                            requirementMap.set(targetItemId, bucket);
                            matchedCount++;
                        });

                        this.odooRequirements = Array.from(requirementMap.values());
                        this.odooImportMeta = {
                            fileName: file.name,
                            importedRows: matchedCount,
                            unmatchedRows: unmatched,
                            autoCreatedItems: autoCreatedItems.map(item => ({ id: item.id, code: item.code, name: item.name })),
                            importedAt: new Date().toISOString()
                        };

                        this.saveToStorage();
                        if (autoCreatedItems.length) {
                            this.renderStockTable();
                        }
                        this.renderProduction();
                        const msgParts = [`${matchedCount} line(s) imported`];
                        if (unmatched.length) msgParts.push(`${unmatched.length} unmatched`);
                        if (autoCreatedItems.length) msgParts.push(`${autoCreatedItems.length} new item${autoCreatedItems.length === 1 ? '' : 's'} created`);
                        const msg = msgParts.join(', ');
                        this.showNotification(msg, unmatched.length ? 'info' : 'success');
                        if (unmatched.length) {
                            console.warn('Unmatched Odoo rows', unmatched);
                        }
                    } catch (error) {
                        console.error(error);
                        this.showNotification('Failed to parse Odoo file', 'error');
                    } finally {
                        if (evt?.target) evt.target.value = '';
                    }
                };

                if (isCsv) {
                    reader.readAsText(file, 'utf-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            }

            getOrderRequirementQty(itemId) {
                return this.orders
                    .filter(o => ['pending', 'confirmed'].includes(o.status))
                    .reduce((total, order) => {
                        const lineItem = (order.lineItems || []).find(li => li.itemId === itemId);
                        return total + (lineItem ? lineItem.qty : 0);
                    }, 0);
            }

            getOdooRequirementQty(itemId) {
                return (this.odooRequirements || [])
                    .filter(req => req.itemId === itemId)
                    .reduce((total, req) => total + (parseFloat(req.qty) || 0), 0);
            }

            calculateRequiredQty(itemId) {
                return this.getOrderRequirementQty(itemId) + this.getOdooRequirementQty(itemId);
            }

            calculateProducedQty(itemId) {
                // Sum all produced quantities from production records
                return this.production
                    .filter(p => p.itemId === itemId)
                    .reduce((total, p) => total + p.quantity, 0);
            }

            getItemLabel(itemId) {
                const item = this.stockItems.find(i => i.id === itemId);
                return item ? item.name : `Item #${itemId}`;
            }

            archiveCurrentProductionState() {
                const hasData =
                    (this.production && this.production.length ? this.production.length : 0) +
                    (this.odooRequirements && this.odooRequirements.length ? this.odooRequirements.length : 0) +
                    (this.operations && this.operations.length ? this.operations.length : 0) +
                    (this.packaging && this.packaging.length ? this.packaging.length : 0) +
                    (this.manufacturingRuns && this.manufacturingRuns.length ? this.manufacturingRuns.length : 0);
                if (!hasData) return null;

                const nextId = this.productionArchives.length ? Math.max(...this.productionArchives.map(a => a.id)) + 1 : 1;
                const productionClone = (this.production || []).map(entry => ({ ...entry, itemName: entry.itemName || this.getItemLabel(entry.itemId) }));
                const summaryMap = new Map();
                productionClone.forEach(entry => {
                    const label = entry.itemName || this.getItemLabel(entry.itemId);
                    const qty = entry.quantity || 0;
                    summaryMap.set(label, (summaryMap.get(label) || 0) + qty);
                });
                const summary = Array.from(summaryMap.entries()).map(([name, qty]) => ({ name, qty }));
                const snapshot = {
                    id: nextId,
                    createdAt: new Date().toISOString(),
                    production: productionClone,
                    odooRequirements: JSON.parse(JSON.stringify(this.odooRequirements || [])),
                    manufacturingRuns: JSON.parse(JSON.stringify(this.manufacturingRuns || [])),
                    operations: JSON.parse(JSON.stringify(this.operations || [])),
                    packaging: JSON.parse(JSON.stringify(this.packaging || [])),
                    summary,
                    totalItems: summary.length,
                    totalQty: summary.reduce((sum, row) => sum + (row.qty || 0), 0)
                };
                this.productionArchives.push(snapshot);
                this.renderProductionArchives();
                return snapshot;
            }

            renderProductionArchives() {
                const container = document.getElementById('productionArchiveContent');
                if (!container) return;
                const q = (document.getElementById('productionArchiveSearch')?.value || '').toLowerCase();
                const archives = (this.productionArchives || []).slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const filtered = archives.filter(archive => {
                    if (!q) return true;
                    const dateStr = archive.createdAt ? new Date(archive.createdAt).toLocaleString().toLowerCase() : '';
                    const summaryMatch = (archive.summary || []).some(row => row.name.toLowerCase().includes(q));
                    return dateStr.includes(q) || summaryMatch;
                });

                if (!filtered.length) {
                    container.innerHTML = '<p style="color:#777;">No archived production batches yet.</p>';
                    return;
                }

                const rows = filtered.map(archive => {
                    const dateLabel = archive.createdAt ? new Date(archive.createdAt).toLocaleString() : 'Unknown';
                    const topItems = (archive.summary || []).slice(0, 3).map(row => `${row.name}: <strong>${row.qty}</strong>`).join(' ‚Ä¢ ');
                    const moreLabel = (archive.summary || []).length > 3 ? ` +${(archive.summary || []).length - 3} more` : '';
                    return `<tr>
                        <td>#${archive.id}</td>
                        <td>${dateLabel}</td>
                        <td>${archive.totalItems || 0}</td>
                        <td>${archive.totalQty || 0}</td>
                        <td>${topItems || '-'}${moreLabel}</td>
                        <td>
                            <button class="btn-small btn-secondary" onclick="app.exportProductionArchive(${archive.id})">Export</button>
                        </td>
                    </tr>`;
                }).join('');

                container.innerHTML = `<table class="table"><thead><tr><th>ID</th><th>Date</th><th>Items</th><th>Total Qty</th><th>Highlights</th><th>Report</th></tr></thead><tbody>${rows}</tbody></table>`;
            }

            exportProductionArchive(archiveId) {
                const archive = (this.productionArchives || []).find(a => a.id === archiveId);
                if (!archive) {
                    this.showNotification('Archive not found', 'error');
                    return;
                }

                const lines = [];
                const pushLine = (row) => lines.push(row.map(col => `"${('' + (col ?? '')).replace(/"/g, '""')}"`).join(','));
                pushLine(['Archive ID', archive.id]);
                pushLine(['Created At', archive.createdAt ? new Date(archive.createdAt).toLocaleString() : '']);
                pushLine([]);
                pushLine(['Item', 'Quantity']);
                (archive.summary || []).forEach(row => pushLine([row.name, row.qty]));
                pushLine([]);
                pushLine(['Production Records']);
                pushLine(['Item', 'Quantity', 'Notes', 'Recorded At']);
                (archive.production || []).forEach(entry => pushLine([
                    entry.itemName || this.getItemLabel(entry.itemId),
                    entry.quantity || 0,
                    entry.notes || '',
                    entry.date ? new Date(entry.date).toLocaleString() : ''
                ]));

                const csv = lines.join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `production_archive_${archive.id}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            resetProductionData() {
                if (!confirm('This will clear Odoo imports, production records, packaging, operations, and manufacturing history. Continue?')) {
                    return;
                }

                const snapshot = this.archiveCurrentProductionState();
                this.odooRequirements = [];
                this.odooImportMeta = null;
                this.production = [];
                this.operations = [];
                this.operationShiftMeta = {
                    id: this.operationShiftMeta?.id || 1,
                    startedAt: null,
                    endedAt: new Date().toISOString()
                };
                this.packaging = [];
                this.manufacturingRuns = [];
                this.currentManufacturingPlan = null;

                this.saveToStorage();
                this.renderProduction();
                this.renderOperation && this.renderOperation();
                this.renderPackaging && this.renderPackaging();
                this.renderManufacturing && this.renderManufacturing();
                this.renderOperationReports && this.renderOperationReports();
                this.renderPackagingReports && this.renderPackagingReports();
                const message = snapshot ? 'Production data archived and reset' : 'Production data reset';
                this.showNotification(message, 'success');
            }

            renderProduction() {
                const content = document.getElementById('productionContent');
                if (!content) return;
                this.renderProductionTable();
                this.renderProductionArchives();
                this.initProductionMasterFilters();
                this.renderProductionMasterReport();
            }

            renderProductionTable() {
                const content = document.getElementById('productionContent');
                if (!content) return;

                const formatQty = (val) => {
                    const num = Number(val) || 0;
                    return Math.abs(num % 1) < 1e-6 ? num.toString() : num.toFixed(2);
                };

                let html = '';
                const importMeta = this.odooImportMeta;
                if (importMeta) {
                    const preview = (this.odooRequirements || []).slice(0, 5).map(req => {
                        const item = this.stockItems.find(i => i.id === req.itemId);
                        const label = item ? item.name : `Item #${req.itemId}`;
                        return `<span style="display:inline-block;margin-right:12px;margin-bottom:4px;">${label}: <strong>${formatQty(req.qty)}</strong></span>`;
                    }).join('') || '<span style="color:#777;">No matching stock items in last import.</span>';
                    const unmatchedCount = (importMeta.unmatchedRows || []).length;
                    const importTime = importMeta.importedAt ? new Date(importMeta.importedAt).toLocaleString() : '';
                    const unmatchedList = unmatchedCount ? importMeta.unmatchedRows.slice(0, 5).map(row => {
                        const label = [row.code || '(no code)', row.name || ''].filter(Boolean).join(' ¬∑ ');
                        return `${label} (${formatQty(row.qty || 0)})`;
                    }).join('<br>') : '';
                    html += `<div style="padding:12px;border:1px solid #b7eb8f;background:#f6ffed;border-radius:10px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;">
                            <div>
                                <div style="font-weight:600;">Odoo import: ${importMeta.fileName || 'Unknown file'}</div>
                                <div style="font-size:12px;color:#555;">${importMeta.importedRows || 0} matched line(s) ‚Ä¢ ${importTime}</div>
                            </div>
                            ${unmatchedCount ? `<div style="font-size:12px;color:#c27c00;">${unmatchedCount} unmatched item${unmatchedCount === 1 ? '' : 's'}</div>` : ''}
                        </div>
                        <div style="margin-top:8px;font-size:13px;color:#333;">${preview}</div>
                        ${unmatchedCount ? `<details style="margin-top:8px;">
                            <summary style="cursor:pointer;font-size:13px;color:#c27c00;">View unmatched entries</summary>
                            <div style="margin-top:6px;font-size:12px;color:#555;">${unmatchedList}${unmatchedCount > 5 ? '<br>‚Ä¶' : ''}</div>
                        </details>` : ''}
                    </div>`;
                }

                // Get unique items from orders and imported Odoo demand
                const itemsInOrders = new Set();
                this.orders
                    .filter(o => ['pending', 'confirmed'].includes(o.status))
                    .forEach(o => {
                        (o.lineItems || []).forEach(li => itemsInOrders.add(li.itemId));
                    });
                (this.odooRequirements || []).forEach(req => {
                    if (req.itemId) itemsInOrders.add(req.itemId);
                });

                if (itemsInOrders.size === 0) {
                    const fallbackText = (importMeta && (importMeta.unmatchedRows || []).length)
                        ? 'Odoo file imported but none of the codes matched stock items. Update your item codes or import a different file.'
                        : 'No items to produce. No orders or imported requirements yet.';
                    html += `<p style="padding:20px;text-align:center;color:#666;">${fallbackText}</p>`;
                    content.innerHTML = html;
                    return;
                }

                html += '<table class="table"><thead><tr><th>Item</th><th>Required Qty</th><th>Produced Qty</th><th>Remaining</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                itemsInOrders.forEach(itemId => {
                    const item = this.stockItems.find(i => i.id === itemId);
                    const orderQty = this.getOrderRequirementQty(itemId);
                    const odooQty = this.getOdooRequirementQty(itemId);
                    const required = orderQty + odooQty;
                    const produced = this.calculateProducedQty(itemId);
                    const remaining = required - produced;
                    const status = remaining <= 0 ? '‚úÖ Complete' : `‚è≥ ${formatQty(Math.max(remaining, 0))} remaining`;
                    const statusColor = remaining <= 0 ? 'color:#4CAF50' : 'color:#FF9800';
                    const breakdownBits = [];
                    if (orderQty) breakdownBits.push(`Orders ${formatQty(orderQty)}`);
                    if (odooQty) breakdownBits.push(`Odoo ${formatQty(odooQty)}`);
                    const breakdownHtml = breakdownBits.length ? `<div style="font-size:11px;color:#666;">${breakdownBits.join(' ‚Ä¢ ')}</div>` : '';

                    html += `<tr>
                        <td>${item ? item.name : 'Deleted'}</td>
                        <td><strong>${formatQty(required)}</strong>${breakdownHtml}</td>
                        <td><strong>${formatQty(produced)}</strong></td>
                        <td><strong style="${statusColor}">${formatQty(remaining)}</strong></td>
                        <td>${status}</td>
                        <td>
                            <button class="btn-small btn-primary" onclick="app.showProductionModal(${itemId})">Record Production</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            }

            getProductionHistoryEntries() {
                const entries = [];
                (this.production || []).forEach(prod => {
                    const record = { ...prod, recordedAt: prod.date || prod.recordedAt || new Date().toISOString() };
                    const entry = this.buildHistoryEntry(record, 'Current Batch', record.recordedAt, 'current');
                    entry.ref = prod.id || entry.ref || '-';
                    entries.push(entry);
                });

                (this.productionArchives || []).forEach(archive => {
                    const sourceLabel = `Archive #${archive.id}${archive.createdAt ? ' (' + new Date(archive.createdAt).toLocaleString() + ')' : ''}`;
                    const sourceKey = `archive-${archive.id}`;
                    (archive.production || []).forEach((prod, idx) => {
                        const record = {
                            ...prod,
                            recordedAt: prod.date || archive.createdAt || prod.recordedAt,
                            itemId: prod.itemId
                        };
                        const entry = this.buildHistoryEntry(record, sourceLabel, record.recordedAt, sourceKey);
                        entry.ref = prod.id || `PR${archive.id}-${idx + 1}`;
                        entries.push(entry);
                    });
                });

                return entries.sort((a, b) => (b.rawDate || 0) - (a.rawDate || 0));
            }

            initProductionMasterFilters() {
                const categorySelect = document.getElementById('productionFilterCategory');
                const itemSelect = document.getElementById('productionFilterItem');
                const shiftSelect = document.getElementById('productionFilterShift');
                if (!categorySelect || !itemSelect || !shiftSelect) return;

                const prevCategory = categorySelect.value;
                const categories = Array.from(new Set((this.stockItems || []).map(i => i.group || 'Uncategorized'))).sort((a, b) => a.localeCompare(b));
                categorySelect.innerHTML = '<option value="">All categories</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                if (prevCategory && categories.includes(prevCategory)) {
                    categorySelect.value = prevCategory;
                }

                const prevItem = itemSelect.value;
                const items = (this.stockItems || []).slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                itemSelect.innerHTML = '<option value="">All items</option>' + items.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                if (prevItem && items.some(item => String(item.id) === prevItem)) {
                    itemSelect.value = prevItem;
                }

                const prevShift = shiftSelect.value;
                const shiftOptions = ['<option value="">All shifts</option>', '<option value="current">Current Batch</option>'];
                (this.productionArchives || []).forEach(archive => {
                    const label = archive.createdAt ? new Date(archive.createdAt).toLocaleString() : 'Unknown date';
                    shiftOptions.push(`<option value="archive-${archive.id}">Archive #${archive.id} (${label})</option>`);
                });
                shiftSelect.innerHTML = shiftOptions.join('');
                const validShiftValues = new Set(['', 'current', ...(this.productionArchives || []).map(a => `archive-${a.id}`)]);
                shiftSelect.value = validShiftValues.has(prevShift) ? prevShift : '';
            }

            getFilteredProductionMasterData() {
                const entries = this.getProductionHistoryEntries();
                const startVal = document.getElementById('productionFilterStart')?.value;
                const endVal = document.getElementById('productionFilterEnd')?.value;
                const categoryVal = document.getElementById('productionFilterCategory')?.value || '';
                const itemValRaw = document.getElementById('productionFilterItem')?.value;
                const itemVal = itemValRaw ? parseInt(itemValRaw) : null;
                const shiftVal = document.getElementById('productionFilterShift')?.value || '';
                const sortMode = document.getElementById('productionSortBy')?.value || 'dateDesc';

                const startTs = startVal ? new Date(startVal + 'T00:00:00').getTime() : null;
                const endTs = endVal ? new Date(endVal + 'T23:59:59').getTime() : null;

                let filtered = entries.filter(entry => {
                    if (startTs && entry.rawDate < startTs) return false;
                    if (endTs && entry.rawDate > endTs) return false;
                    if (categoryVal && entry.category !== categoryVal) return false;
                    if (itemVal && parseInt(entry.itemId) !== itemVal) return false;
                    if (shiftVal && entry.sourceKey !== shiftVal) return false;
                    return true;
                });

                const comparator = {
                    dateAsc: (a, b) => (a.rawDate || 0) - (b.rawDate || 0),
                    dateDesc: (a, b) => (b.rawDate || 0) - (a.rawDate || 0),
                    category: (a, b) => (a.category || '').localeCompare(b.category || '') || ((b.rawDate || 0) - (a.rawDate || 0)),
                    item: (a, b) => (a.itemName || '').localeCompare(b.itemName || '') || ((b.rawDate || 0) - (a.rawDate || 0)),
                    shift: (a, b) => (a.sourceLabel || '').localeCompare(b.sourceLabel || '') || ((b.rawDate || 0) - (a.rawDate || 0))
                };

                const sorter = comparator[sortMode] || comparator.dateDesc;
                filtered = filtered.slice().sort(sorter);
                return filtered;
            }

            renderProductionMasterReport() {
                const container = document.getElementById('productionMasterTable');
                const counter = document.getElementById('productionMasterCount');
                if (!container || !counter) return;
                const data = this.getFilteredProductionMasterData();
                counter.textContent = `${data.length} record${data.length === 1 ? '' : 's'}`;

                const rows = data.map(entry => `
                    <tr>
                        <td>${entry.timeLabel}</td>
                        <td>${entry.itemName}</td>
                        <td>${entry.category || '-'}</td>
                        <td>${entry.quantity}</td>
                        <td>${entry.sourceLabel}</td>
                        <td>${entry.notes || '-'}</td>
                    </tr>
                `).join('');

                container.innerHTML = `<table class="table"><thead><tr><th>Date & Time</th><th>Item</th><th>Category</th><th>Qty</th><th>Shift</th><th>Notes</th></tr></thead><tbody>${rows || '<tr><td colspan="6" style="text-align:center;color:#777;">No data matches the selected filters</td></tr>'}</tbody></table>`;
            }

            exportProductionMasterReport() {
                const data = this.getFilteredProductionMasterData();
                if (!data.length) {
                    this.showNotification('No records to export with current filters', 'error');
                    return;
                }

                const header = ['Date & Time', 'Item', 'Category', 'Quantity', 'Shift', 'Notes'];
                const lines = [header];
                data.forEach(entry => {
                    lines.push([
                        entry.timeLabel,
                        entry.itemName,
                        entry.category || '',
                        entry.quantity,
                        entry.sourceLabel,
                        entry.notes || ''
                    ]);
                });

                const csv = lines.map(row => row.map(col => `"${('' + (col ?? '')).replace(/"/g, '""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `production_master_report_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Production report exported', 'success');
            }

            showProductionModal(itemId = null) {
                const modal = document.getElementById('productionModal');
                const title = document.getElementById('productionModalTitle');

                // Populate item dropdown - only show items with pending/confirmed orders
                const itemsInOrders = new Set();
                this.orders
                    .filter(o => ['pending', 'confirmed'].includes(o.status))
                    .forEach(o => {
                        (o.lineItems || []).forEach(li => itemsInOrders.add(li.itemId));
                    });
                (this.odooRequirements || []).forEach(req => {
                    if (req.itemId) itemsInOrders.add(req.itemId);
                });

                const itemSelect = document.getElementById('modalProductionItem');
                itemSelect.innerHTML = '<option value="">Select an item</option>';
                itemsInOrders.forEach(iId => {
                    const item = this.stockItems.find(i => i.id === iId);
                    if (item) {
                        itemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                    }
                });

                title.textContent = 'Record Production';
                document.getElementById('modalProductionQuantity').value = '';
                document.getElementById('modalProductionNotes').value = '';

                if (itemId) {
                    itemSelect.value = itemId;
                    this.updateProductionDisplay(itemId);
                } else {
                    itemSelect.value = '';
                    document.getElementById('productionRequired').textContent = '0';
                    document.getElementById('productionProduced').textContent = '0';
                    document.getElementById('productionRemaining').textContent = '0';
                }

                modal.classList.add('active');
            }

            updateProductionDisplay(itemId) {
                if (!itemId) {
                    document.getElementById('productionRequired').textContent = '0';
                    document.getElementById('productionProduced').textContent = '0';
                    document.getElementById('productionRemaining').textContent = '0';
                    return;
                }

                const required = this.calculateRequiredQty(itemId);
                const produced = this.calculateProducedQty(itemId);
                const remaining = required - produced;

                document.getElementById('productionRequired').textContent = required;
                document.getElementById('productionProduced').textContent = produced;
                document.getElementById('productionRemaining').textContent = remaining;
            }

            saveProduction() {
                const itemId = parseInt(document.getElementById('modalProductionItem').value);
                const quantity = parseInt(document.getElementById('modalProductionQuantity').value) || 0;
                const notes = document.getElementById('modalProductionNotes').value;

                if (!itemId || quantity <= 0) {
                    this.showNotification('Please select an item and enter a valid quantity', 'error');
                    return;
                }

                const newProduction = {
                    id: this.production.length > 0 ? Math.max(...this.production.map(p => p.id)) + 1 : 1,
                    itemId,
                    quantity,
                    date: new Date().toISOString(),
                    notes
                };

                this.production.push(newProduction);
                this.saveToStorage();
                this.closeProductionModal();
                this.renderProductionTable();
                this.initProductionMasterFilters();
                this.renderProductionMasterReport();

                this.showNotification(`Recorded ${quantity} units produced`, 'success');
            }

            closeProductionModal() {
                document.getElementById('productionModal').classList.remove('active');
            }

            /* MANUFACTURING METHODS */
            renderManufacturing() {
                const productSelect = document.getElementById('manufacturingProductSelect');
                const qtyInput = document.getElementById('manufacturingQuantity');
                if (!productSelect || !qtyInput) return;

                const bomItems = (this.stockItems || []).filter(item => (item.bom && item.bom.length));
                productSelect.innerHTML = '<option value="">Select an item with a BOM</option>';

                if (bomItems.length === 0) {
                    productSelect.innerHTML = '<option value="">No BOM-defined items</option>';
                    productSelect.disabled = true;
                    const statusEl = document.getElementById('manufacturingStatus');
                    const body = document.getElementById('manufacturingBomBody');
                    const summary = document.getElementById('manufacturingSummary');
                    const confirmBtn = document.getElementById('manufacturingConfirmBtn');
                    if (statusEl) {
                        statusEl.style.color = '#666';
                        statusEl.textContent = 'Create a finished good with a BOM before manufacturing.';
                    }
                    if (body) body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">No items with BOM are available yet.</td></tr>';
                    if (summary) summary.textContent = '';
                    if (confirmBtn) confirmBtn.disabled = true;
                    this.currentManufacturingPlan = null;
                    this.renderManufacturingHistory();
                    return;
                }

                productSelect.disabled = false;
                bomItems.forEach(item => {
                    productSelect.innerHTML += '<option value="' + item.id + '">' + item.name + ' (' + (item.code || 'no code') + ')</option>';
                });

                if (this.currentManufacturingPlan && bomItems.some(i => i.id === this.currentManufacturingPlan.productId)) {
                    productSelect.value = this.currentManufacturingPlan.productId;
                    qtyInput.value = this.currentManufacturingPlan.quantity;
                } else {
                    productSelect.value = '';
                    qtyInput.value = qtyInput.value || 1;
                    this.currentManufacturingPlan = null;
                }

                this.updateManufacturingPlan();
                this.renderManufacturingHistory();
            }

            updateManufacturingPlan() {
                const productSelect = document.getElementById('manufacturingProductSelect');
                const qtyInput = document.getElementById('manufacturingQuantity');
                const body = document.getElementById('manufacturingBomBody');
                const statusEl = document.getElementById('manufacturingStatus');
                const summaryEl = document.getElementById('manufacturingSummary');
                const confirmBtn = document.getElementById('manufacturingConfirmBtn');
                if (!productSelect || !qtyInput || !body || !statusEl || !summaryEl || !confirmBtn) return;

                let qty = parseFloat(qtyInput.value);
                if (!qty || qty <= 0) qty = 1;
                qtyInput.value = qty;

                const productId = parseInt(productSelect.value);
                if (!productId) {
                    body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">Select a product to view BOM requirements</td></tr>';
                    statusEl.style.color = '#666';
                    statusEl.textContent = 'Select a product to generate material requirements.';
                    summaryEl.textContent = '';
                    confirmBtn.disabled = true;
                    this.currentManufacturingPlan = null;
                    return;
                }

                const product = this.stockItems.find(i => i.id === productId);
                const bom = product && Array.isArray(product.bom) ? product.bom : [];
                if (!bom.length) {
                    body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#d9534f;">This product has no BOM defined.</td></tr>';
                    statusEl.style.color = '#d9534f';
                    statusEl.textContent = 'Add materials to this product before manufacturing.';
                    summaryEl.textContent = '';
                    confirmBtn.disabled = true;
                    this.currentManufacturingPlan = null;
                    return;
                }

                let canManufacture = true;
                const materials = bom.map(entry => {
                    const material = this.stockItems.find(i => i.id === entry.itemId);
                    const required = (entry.qty || 0) * qty;
                    const available = material ? (material.qty || 0) : 0;
                    if ((available + 1e-9) < required) canManufacture = false;
                    return {
                        itemId: entry.itemId,
                        name: material ? material.name : 'Deleted material',
                        unit: material ? (material.unit || '') : '',
                        required: required,
                        available: available,
                        difference: available - required
                    };
                });

                body.innerHTML = materials.map(mat => {
                    const diffColor = mat.difference >= 0 ? '#2e7d32' : '#d9534f';
                    return '<tr>' +
                        '<td>' + mat.name + '</td>' +
                        '<td>' + mat.required.toFixed(3) + ' ' + (mat.unit || '') + '</td>' +
                        '<td>' + mat.available.toFixed(3) + ' ' + (mat.unit || '') + '</td>' +
                        '<td style="font-weight:600;color:' + diffColor + ';">' + mat.difference.toFixed(3) + ' ' + (mat.unit || '') + '</td>' +
                    '</tr>';
                }).join('');

                if (canManufacture) {
                    statusEl.style.color = '#2e7d32';
                    statusEl.textContent = 'All materials available. Ready to manufacture.';
                } else {
                    statusEl.style.color = '#d9534f';
                    statusEl.textContent = 'Insufficient stock for highlighted materials.';
                }
                confirmBtn.disabled = !canManufacture;

                const currentQty = product ? (product.qty || 0) : 0;
                summaryEl.textContent = product ? ('Stock after run: ' + currentQty.toFixed(2) + ' ‚Üí ' + (currentQty + qty).toFixed(2) + ' ' + (product.unit || '')) : '';

                this.currentManufacturingPlan = {
                    productId: productId,
                    quantity: qty,
                    materials: materials,
                    canManufacture: canManufacture
                };
            }

            confirmManufacturingRun() {
                const plan = this.currentManufacturingPlan;
                if (!plan || !plan.productId) {
                    this.showNotification('Select a product and quantity first', 'error');
                    return;
                }
                if (!plan.canManufacture) {
                    this.showNotification('Insufficient materials for this batch', 'error');
                    return;
                }

                const product = this.stockItems.find(i => i.id === plan.productId);
                if (!product) {
                    this.showNotification('Finished good not found', 'error');
                    return;
                }

                for (let idx = 0; idx < plan.materials.length; idx++) {
                    const matPlan = plan.materials[idx];
                    const materialItem = this.stockItems.find(i => i.id === matPlan.itemId);
                    if (!materialItem) {
                        this.showNotification('One of the materials was removed. Refresh the plan.', 'error');
                        this.updateManufacturingPlan();
                        return;
                    }
                    if ((materialItem.qty || 0) + 1e-9 < matPlan.required) {
                        this.showNotification('Stock changed. Not enough ' + materialItem.name + '.', 'error');
                        this.updateManufacturingPlan();
                        return;
                    }
                }

                let nextTxId = this.stockTransactions.length ? Math.max(...this.stockTransactions.map(t => t.id)) + 1 : 1;
                plan.materials.forEach(matPlan => {
                    const materialItem = this.stockItems.find(i => i.id === matPlan.itemId);
                    if (!materialItem) return;
                    materialItem.qty = parseFloat((materialItem.qty - matPlan.required).toFixed(3));
                    this.stockTransactions.push({
                        id: nextTxId++,
                        itemId: materialItem.id,
                        type: 'manufacturing_consume',
                        qty: matPlan.required,
                        date: new Date().toISOString(),
                        note: 'Consumed for ' + product.name
                    });
                });

                product.qty = parseFloat(((product.qty || 0) + plan.quantity).toFixed(3));
                this.stockTransactions.push({
                    id: nextTxId++,
                    itemId: product.id,
                    type: 'manufacturing_output',
                    qty: plan.quantity,
                    date: new Date().toISOString(),
                    note: 'Manufacturing output'
                });

                const runId = this.manufacturingRuns.length ? Math.max(...this.manufacturingRuns.map(r => r.id)) + 1 : 1;
                this.manufacturingRuns.push({
                    id: runId,
                    productId: product.id,
                    productName: product.name,
                    quantity: plan.quantity,
                    unit: product.unit || 'pcs',
                    date: new Date().toISOString(),
                    materials: plan.materials.map(mat => ({
                        itemId: mat.itemId,
                        name: mat.name,
                        qty: mat.required,
                        unit: mat.unit
                    }))
                });

                this.saveToStorage();
                this.updateStats();
                this.renderManufacturingHistory();
                this.renderManufacturing();
                this.renderStockTable();
                this.renderStockTransactions();
                this.showNotification('Manufacturing completed successfully', 'success');
                this.logActivity('Manufactured ' + plan.quantity + ' ' + (product.unit || '') + ' of ' + product.name);
            }

            renderManufacturingHistory() {
                const container = document.getElementById('manufacturingHistory');
                const countLabel = document.getElementById('manufacturingHistoryCount');
                if (!container) return;

                if (!this.manufacturingRuns.length) {
                    container.innerHTML = '<p style="color:#777;">No manufacturing runs recorded yet.</p>';
                    if (countLabel) countLabel.textContent = '';
                    return;
                }

                const runs = this.manufacturingRuns.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 8);
                const rows = runs.map(run => {
                    const materials = (run.materials || []).map(mat => {
                        const qtyVal = typeof mat.qty === 'number' ? mat.qty : (parseFloat(mat.qty) || 0);
                        return (mat.name || 'Material') + ' ' + qtyVal.toFixed(2) + ' ' + (mat.unit || '');
                    }).join('<br>');
                    const dateStr = run.date ? new Date(run.date).toLocaleString() : '';
                    const runQty = typeof run.quantity === 'number' ? run.quantity : (parseFloat(run.quantity) || 0);
                    return '<tr>' +
                        '<td>' + dateStr + '</td>' +
                        '<td>' + (run.productName || 'Product') + '</td>' +
                        '<td>' + runQty.toFixed(2) + ' ' + (run.unit || '') + '</td>' +
                        '<td>' + (materials || '-') + '</td>' +
                    '</tr>';
                }).join('');

                container.innerHTML = '<table class="table"><thead><tr><th>Date</th><th>Product</th><th>Output</th><th>Materials Used</th></tr></thead><tbody>' + rows + '</tbody></table>';
                if (countLabel) countLabel.textContent = this.manufacturingRuns.length + ' total runs';
            }
        }

        // BOM Editor Helpers
        BakeryApp.prototype.addBomRow = function(itemId, qty) {
            var bomList = document.getElementById('bomList');
            var row = document.createElement('div');
            row.className = 'bom-row';
            row.style.cssText = 'display:flex; gap:8px; margin-bottom:8px; align-items:center;';
            
            // Create dropdown of RM items
            var rmItems = app.stockItems.filter(function(item) { return item.group === 'RM'; });
            var selectHtml = '<select class="bom-material" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"><option value="">-- Select Material --</option>';
            rmItems.forEach(function(item) {
                selectHtml += '<option value="' + item.id + '"' + (itemId == item.id ? ' selected' : '') + '>' + item.name + ' (' + item.code + ')</option>';
            });
            selectHtml += '</select>';
            
            row.innerHTML = selectHtml +
                '<input type="number" class="bom-qty" placeholder="Qty" min="0" step="0.01" value="' + (qty || '') + '" style="flex:0.9; min-width:120px; padding:10px; border:1px solid #ddd; border-radius:6px;">' +
                '<button type="button" class="btn btn-danger" onclick="this.parentNode.remove()" style="padding:6px 10px;">Remove</button>';
            bomList.appendChild(row);
        };

        // Initialize app
        var app = new BakeryApp();
    </script>
</body>
</html>
